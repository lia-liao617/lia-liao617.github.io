<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>å¿ƒæƒ…æ—¥è¨˜ï¼ˆæœ¬æ©ŸåŠ å¯†ï¼‰</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%23f472b6'/%3E%3Ctext x='50' y='58' text-anchor='middle' font-size='54' font-family='Arial' fill='white'%3E%E2%9D%A4%EF%B8%8F%3C/text%3E%3C/svg%3E" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body,#root{height:100%}
    @supports(height: 100svh){ .svh90{ max-height:90svh } }
    /* éŒ¯èª¤æµ®å±¤ï¼ˆè‹¥æœ‰ä¾‹å¤–æœƒé¡¯ç¤ºï¼‰ */
    #errbox{position:fixed;top:8px;right:8px;z-index:99999;background:#fee2e2;color:#7f1d1d;border:1px solid #fecaca;border-radius:12px;padding:10px 12px;max-width:90vw;white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, monospace;font-size:12px;box-shadow:0 10px 25px rgba(0,0,0,.1)}
  </style>
</head>
<body class="bg-pink-50">
  <div id="root"></div>

  <!-- éŒ¯èª¤æ””æˆªï¼šè‹¥æœ‰ä¾‹å¤–ç›´æ¥é¡¯ç¤ºæ–¼é é¢ -->
  <script>
    (function(){
      function showError(msg,stack){
        var el=document.getElementById('errbox');
        if(!el){ el=document.createElement('pre'); el.id='errbox'; document.body.appendChild(el); }
        el.textContent='âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼š\\n'+msg+(stack?'\\n'+stack:'');
      }
      window.addEventListener('error', function(e){ showError(e.message, (e.error&&e.error.stack)||''); });
      window.addEventListener('unhandledrejection', function(e){
        var reason=e.reason||{};
        showError((reason.message)||String(reason), (reason.stack)||'');
      });
    })();
  </script>

  <!-- React 18 UMD + Babelï¼ˆç€è¦½å™¨ç«¯ç·¨è­¯ JSXï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>

  <!-- ä¸»è¦ç¨‹å¼ï¼šé¿å…ä½¿ç”¨å®¹æ˜“å¼•ç™¼ç›¸å®¹æ€§å•é¡Œçš„èªæ³•ï¼ˆç§»é™¤ ?. èˆ‡æ•¸å­—åº•ç·šï¼‰ -->
  <script type="text/babel" data-presets="env,react" data-plugins="proposal-optional-chaining,proposal-nullish-coalescing-operator">
    const { useState, useEffect, useMemo, useRef } = React;

    // ===== Base64 <-> ArrayBuffer =====
    const ab2b64 = (buffer) => { const bytes = new Uint8Array(buffer); let binary=""; for(let i=0;i<bytes.byteLength;i++) binary += String.fromCharCode(bytes[i]); return btoa(binary); };
    const b642ab = (b64) => { const binary = atob(b64); const bytes = new Uint8Array(binary.length); for(let i=0;i<binary.length;i++) bytes[i]=binary.charCodeAt(i); return bytes.buffer; };

    // ===== WebCryptoï¼šé‡‘é‘°å°å‡º/åŠ è§£å¯† =====
    const textEncoder = new TextEncoder(), textDecoder = new TextDecoder();
    async function deriveKey(password, saltB64){
      const salt = saltB64 ? new Uint8Array(b642ab(saltB64)) : crypto.getRandomValues(new Uint8Array(16));
      const baseKey = await crypto.subtle.importKey("raw", textEncoder.encode(password), "PBKDF2", false, ["deriveKey"]);
      const aesKey  = await crypto.subtle.deriveKey({ name:"PBKDF2", salt, iterations:250000, hash:"SHA-256" }, baseKey, { name:"AES-GCM", length:256 }, false, ["encrypt","decrypt"]);
      return { key:aesKey, saltB64: ab2b64(salt) };
    }
    async function encryptJSON(obj, key){
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const plaintext = textEncoder.encode(JSON.stringify(obj));
      const ciphertext = await crypto.subtle.encrypt({ name:"AES-GCM", iv }, key, plaintext);
      return { iv: ab2b64(iv), data: ab2b64(ciphertext) };
    }
    async function decryptJSON(payload, key){
      const ivArr = new Uint8Array(b642ab(payload.iv));
      const cipherAB = b642ab(payload.data);
      const plaintextAB = await crypto.subtle.decrypt({ name:"AES-GCM", iv:ivArr }, key, cipherAB);
      return JSON.parse(textDecoder.decode(plaintextAB));
    }

    // ===== localStorage keys =====
    const LS_PREFIX="moodDiary_";
    const LS_SALT=LS_PREFIX+"salt", LS_VERIFIER=LS_PREFIX+"verifier", LS_TEMPLATES=LS_PREFIX+"templates", LS_CSTICKERS=LS_PREFIX+"cstickers";

    // ===== æ—¥æœŸ =====
    function toDateStr(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,"0"); const day=String(d.getDate()).padStart(2,"0"); return y+"-"+m+"-"+day; }
    function getMonthMatrix(y,m){ const first=new Date(y,m,1); const firstDay=first.getDay(); const daysInMonth=new Date(y,m+1,0).getDate(); const cells=[]; for(let i=0;i<firstDay;i++) cells.push(null); for(let d=1; d<=daysInMonth; d++) cells.push(new Date(y,m,d)); while(cells.length%7!==0) cells.push(null); while(cells.length<42) cells.push(null); return cells; }
    function getMonday(d){ const x=new Date(d.getFullYear(), d.getMonth(), d.getDate()); const day=x.getDay(); const diff=(day===0?-6:1-day); x.setDate(x.getDate()+diff); x.setHours(0,0,0,0); return x; }

    // ===== åœ–ç‰‡å£“ç¸® =====
    async function fileToDataURLCompressed(file){
      return new Promise((resolve,reject)=>{
        const reader=new FileReader();
        reader.onload=function(){
          const img=new Image();
          img.onload=function(){
            const canvas=document.createElement("canvas");
            var width=img.width, height=img.height; const max=1600;
            if(width>height && width>max){ height=Math.round((height*max)/width); width=max; }
            else if(height>max){ width=Math.round((width*max)/height); height=max; }
            canvas.width=width; canvas.height=height;
            const ctx=canvas.getContext("2d"); ctx.drawImage(img,0,0,width,height);
            const isPng = (file.type||"").indexOf("png")>=0;
            const dataUrl=canvas.toDataURL(isPng?"image/png":"image/jpeg", isPng?0.92:0.85);
            resolve(dataUrl);
          };
          img.onerror=reject; img.src=reader.result;
        };
        reader.onerror=reject; reader.readAsDataURL(file);
      });
    }

    // ===== å°å·¥å…· =====
    const STICKERS=["ğŸ»","ğŸ°","ğŸ±","ğŸŒ¸","ğŸ“","âœ¨","ğŸ’–","ğŸ°","â­","ğŸ˜»","ğŸ€","ğŸŒˆ","ğŸ€","ğŸ¥","ğŸ§¸","â˜ï¸","ğŸŒ¼"];
    const reorderByIds=(list,fromId,toId)=>{ const a=list.findIndex(x=>x.id===fromId); const b=list.findIndex(x=>x.id===toId); if(a===-1||b===-1||a===b) return list; const copy=[...list]; const [item]=copy.splice(a,1); copy.splice(b,0,item); return copy; };

    // ===== è¡¨å–®ï¼šè¨­å®š/è§£é– =====
    function SetPasswordForm({ onSet }){ const [p1,setP1]=useState(""), [p2,setP2]=useState(""), [show,setShow]=useState(false);
      const submit=async(e)=>{ e.preventDefault(); if(p1.length<6) return alert("è«‹è‡³å°‘ 6 ç¢¼å¯†ç¢¼"); if(p1!==p2) return alert("å…©æ¬¡è¼¸å…¥ä¸ä¸€è‡´"); await onSet(p1); };
      return (<form onSubmit={submit} className="space-y-4"><div><label className="text-sm text-gray-600">è¨­å®šå¯†ç¢¼</label><input type={show?"text":"password"} className="mt-1 w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-300" value={p1} onChange={(e)=>setP1(e.target.value)} placeholder="è‡³å°‘ 6 ç¢¼"/></div><div><label className="text-sm text-gray-600">å†æ¬¡è¼¸å…¥å¯†ç¢¼</label><input type={show?"text":"password"} className="mt-1 w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-300" value={p2} onChange={(e)=>setP2(e.target.value)}/></div><div className="flex items-center gap-2 text-sm"><input id="showPwd" type="checkbox" checked={show} onChange={(e)=>setShow(e.target.checked)} /><label htmlFor="showPwd">é¡¯ç¤ºå¯†ç¢¼</label></div><button className="w-full bg-pink-500 hover:bg-pink-600 text-white rounded-xl py-2 font-semibold">è¨­å®šä¸¦é€²å…¥</button></form>); }
    function UnlockForm({ onUnlock }){ const [pwd,setPwd]=useState(""), [show,setShow]=useState(false); const submit=async(e)=>{ e.preventDefault(); await onUnlock(pwd); }; return (<form onSubmit={submit} className="space-y-4"><div><label className="text-sm text-gray-600">è¼¸å…¥å¯†ç¢¼</label><input type={show?"text":"password"} className="mt-1 w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-300" value={pwd} onChange={(e)=>setPwd(e.target.value)} /></div><div className="flex items-center gap-2 text-sm"><input id="showPwd2" type="checkbox" checked={show} onChange={(e)=>setShow(e.target.checked)} /><label htmlFor="showPwd2">é¡¯ç¤ºå¯†ç¢¼</label></div><button className="w-full bg-purple-500 hover:bg-purple-600 text-white rounded-xl py-2 font-semibold">è§£é–</button></form>); }

    // ===== æœˆæ›†æ ¼ =====
    function CalendarGrid({ cells, entryMap, weeklyBadgeMap, todayStr, onPick }) {
      const weekdays=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
      const badgeColor = (s)=> s==='done'?'bg-emerald-500': s==='delay'?'bg-amber-500':'bg-sky-500';
      return (
        <div>
          <div className="grid grid-cols-7 text-center text-sm text-gray-500 mb-2">{weekdays.map((w)=>(<div key={w} className="py-1">{w}</div>))}</div>
          <div className="grid grid-cols-7 gap-1 sm:gap-2">
            {cells.map((d,idx)=>{
              if(!d) return <div key={idx} className="aspect-square rounded-xl bg-transparent" />;
              const dateStr=toDateStr(d);
              const isToday=dateStr===todayStr;
              const hasDiary=entryMap.has(d.getDate());
              const badge = weeklyBadgeMap.get(d.getDate());
              return (
                <button key={idx} onClick={()=>onPick(d)} className={"relative aspect-square rounded-xl p-2 text-left border hover:shadow transition "+(isToday?"border-pink-400 bg-pink-50":"border-gray-200 bg-white")} title={(hasDiary?"æœ‰æ—¥è¨˜ ":"")+(badge?("é€±è¨ˆåŠƒ:"+badge):"")}>
                  <div className="flex items-center justify-between">
                    <div className="text-sm font-semibold">{d.getDate()}</div>
                    {hasDiary && <span className="absolute top-1 left-1 inline-block w-2 h-2 rounded-full bg-pink-500"></span>}
                    {badge && <span className={"absolute bottom-1 right-1 inline-block w-2 h-2 rounded-full "+badgeColor(badge)}></span>}
                  </div>
                </button>
              );
            })}
          </div>
        </div>
      );
    }

    // ===== ä»Šå¤©å¡ç‰‡ =====
    function TodayTasksCard({ dateStr, tasks, newTaskText, setNewTaskText, addTask, toggleTask, updateTaskText, removeTask, reorderTasks, openToday }) {
      const hasTasks = tasks && tasks.length > 0; const done = tasks.filter((t)=>t.done).length; const total=tasks.length; const pct = total? Math.round((done*100)/total):0;
      const [dragId,setDragId]=useState(null);
      return (
        <div className={"rounded-2xl shadow "+ (hasTasks?"bg-white/90":"bg-white/70") +" p-4 sm:p-6"}>
          <div className="flex items-center justify-between mb-3">
            <div><div className="text-sm text-gray-500">ä»Šå¤© {dateStr}</div><div className="text-lg font-semibold">ä»Šå¤©çš„å¾…è¾¦</div></div>
            <div className="flex items-center gap-3">
              <div className="relative w-10 h-10 rounded-full" style={{ background: `conic-gradient(#ec4899 ${pct}%, #e5e7eb 0)` }}>
                <div className="absolute inset-1 rounded-full bg-white flex items-center justify-center text-xs text-gray-600">{done}/{total}</div>
              </div>
              <button onClick={openToday} className="px-3 py-1.5 rounded-lg bg-pink-500 text-white text-sm hover:bg-pink-600">ç·¨è¼¯ä»Šå¤©æ—¥è¨˜</button>
            </div>
          </div>
          <div className="flex items-center gap-2 mb-3">
            <input value={newTaskText} onChange={(e)=>setNewTaskText(e.target.value)} onKeyDown={(e)=>{ if(e.key==='Enter') addTask(); }} placeholder={hasTasks?"æ–°å¢å¾…è¾¦...":"å¯«ä¸‹ä»Šå¤©è¦åšçš„äº‹ï¼ˆEnter æ–°å¢ï¼‰"} className="flex-1 border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-300" />
            <button onClick={addTask} className="px-3 py-2 rounded-xl bg-gray-800 text-white text-sm">æ–°å¢</button>
          </div>
          {hasTasks?(
            <ul className="space-y-2">
              {tasks.map((t)=>(
                <li key={t.id} className="flex items-center gap-2 p-2 rounded-lg border bg-white" draggable onDragStart={()=>setDragId(t.id)} onDragOver={(e)=>e.preventDefault()} onDrop={()=>{ if(dragId && dragId!==t.id) reorderTasks(dragId, t.id); setDragId(null); }}>
                  <span className="cursor-grab select-none px-1 text-gray-400">â‹®â‹®</span>
                  <input type="checkbox" checked={!!t.done} onChange={()=>toggleTask(t.id)} className="w-5 h-5" />
                  <input className={"flex-1 bg-transparent focus:outline-none "+(t.done?"line-through text-gray-400":"")} value={t.text} onChange={(e)=>updateTaskText(t.id, e.target.value)} />
                  <button onClick={()=>removeTask(t.id)} className="text-xs text-red-600 hover:underline">åˆªé™¤</button>
                </li>
              ))}
            </ul>
          ):(<div className="text-sm text-gray-500">ä»Šå¤©é‚„æ²’æœ‰å¾…è¾¦ï¼Œå…ˆå¯«ä¸€å€‹å§ï¼</div>)}
        </div>
      );
    }

    // ===== é€¾æœŸå¡ç‰‡ =====
    function OverdueCard({ overdue, carryOne, carryAll }){ if(!overdue||!overdue.length) return null; return (
      <div className="rounded-2xl shadow bg-white p-4 sm:p-6 mt-4">
        <div className="flex items-center justify-between mb-2">
          <div className="text-lg font-semibold">è·¨æ—¥æé†’ï¼ˆæœ€è¿‘ 7 å¤©æœªå®Œæˆï¼‰</div>
          <div className="flex items-center gap-2 text-sm">
            <button onClick={function(){carryAll(true);}} className="px-3 py-1.5 rounded-lg bg-emerald-500 text-white hover:bg-emerald-600">å…¨éƒ¨å¸¶åˆ°ä»Šå¤©ä¸¦æ¨™è¨˜åŸä»»å‹™å®Œæˆ</button>
            <button onClick={function(){carryAll(false);}} className="px-3 py-1.5 rounded-lg bg-gray-200 hover:bg-gray-300">å…¨éƒ¨å¸¶åˆ°ä»Šå¤©ï¼ˆä¸æ¨™è¨˜å®Œæˆï¼‰</button>
          </div>
        </div>
        <ul className="space-y-2">
          {overdue.map(function(it,i){
            return (
              <li key={i} className="flex items-center justify-between p-2 rounded-lg border bg-white">
                <div className="text-sm"><span className="text-gray-500 mr-2">{it.dateStr}</span>{it.text}</div>
                <div className="flex items-center gap-2 text-xs">
                  <button onClick={function(){carryOne(it, true);}} className="px-2 py-1 rounded bg-emerald-100 text-emerald-800 hover:bg-emerald-200">å¸¶åˆ°ä»Šå¤©+å®ŒæˆåŸä»»å‹™</button>
                  <button onClick={function(){carryOne(it, false);}} className="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200">åªå¸¶åˆ°ä»Šå¤©</button>
                </div>
              </li>
            );
          })}
        </ul>
      </div>
    ); }

    // ===== é€±çœ‹æ¿ï¼ˆå°ˆæ¡ˆï¼‰å¸¸é§é¦–é  =====
    function WeeklyBoardSection({ cryptoKey, onChanged }) {
      const [weekStart, setWeekStart] = useState(getMonday(new Date()));
      const days = useMemo(function(){ return Array.from({length:7},function(_,i){ const d=new Date(weekStart); d.setDate(d.getDate()+i); return d; }); }, [weekStart]);
      const weekKey = function(d){ return LS_PREFIX + "board_" + toDateStr(d); };

      const [rows,setRows]=useState([]); const [loading,setLoading]=useState(true);

      const load = async function(){
        setLoading(true);
        const raw = localStorage.getItem(weekKey(weekStart));
        if(!raw){ setRows([]); setLoading(false); return; }
        try{ const obj = await decryptJSON(JSON.parse(raw), cryptoKey); setRows(Array.isArray(obj.rows)?obj.rows:[]); }
        catch(e){ setRows([]); }
        setLoading(false);
      };
      useEffect(function(){ load(); }, [cryptoKey, weekStart]);

      const save = async function(nextRows){
        const payload = await encryptJSON({ rows: nextRows, savedAt: Date.now() }, cryptoKey);
        localStorage.setItem(weekKey(weekStart), JSON.stringify(payload));
        if(onChanged) onChanged();
      };

      const addRow=function(){ const r={id:Date.now()+Math.random(), title:"", daily:{}}; const next=[r, ...rows]; setRows(next); save(next); };
      const delRow=function(id){ const next=rows.filter(function(r){return r.id!==id;}); setRows(next); save(next); };
      const updateTitle=function(id,v){ const next=rows.map(function(r){ return r.id===id?{...r,title:v}:r; }); setRows(next); save(next); };
      const updateCell=function(id, ds, patch){
        const next=rows.map(function(r){
          if(r.id!==id) return r;
          const cur=(r.daily && r.daily[ds]) ? r.daily[ds] : {};
          return { ...r, daily: { ...(r.daily||{}), [ds]: { plan:"", status:"plan", ...cur, ...patch } } };
        });
        setRows(next); save(next);
      };
      const cycleStatus=function(s){ return s==='plan'?'done': (s==='done'?'delay': (s==='delay'?'none':'plan')); };
      const statusClass=function(s){ return s==='done'?'bg-emerald-100 border-emerald-300' : (s==='delay'?'bg-amber-100 border-amber-300' : (s==='plan'?'bg-sky-50 border-sky-200':'bg-white')); };

      const prevWeek=function(){ const d=new Date(weekStart); d.setDate(d.getDate()-7); setWeekStart(d); };
      const nextWeek=function(){ const d=new Date(weekStart); d.setDate(d.getDate()+7); setWeekStart(d); };
      const goThisWeek=function(){ setWeekStart(getMonday(new Date())); };

      return (
        <div className="bg-white/80 backdrop-blur rounded-2xl shadow p-3 sm:p-4 mt-4">
          <div className="flex items-center justify-between mb-2">
            <div className="font-semibold">æœ¬é€±å°ˆæ¡ˆï¼š{toDateStr(days[0])} ~ {toDateStr(days[6])}</div>
            <div className="flex items-center gap-2">
              <button onClick={prevWeek} className="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200">â† ä¸Šé€±</button>
              <button onClick={nextWeek} className="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200">ä¸‹é€± â†’</button>
              <button onClick={goThisWeek} className="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200">å›åˆ°æœ¬é€±</button>
            </div>
          </div>

          <div className="p-3 text-xs text-gray-600 flex flex-wrap gap-3 border rounded-xl">
            <span className="inline-flex items-center gap-1"><span className="inline-block w-3 h-3 rounded border border-sky-200 bg-sky-50"></span> è¨ˆç•«</span>
            <span className="inline-flex items-center gap-1"><span className="inline-block w-3 h-3 rounded border border-emerald-300 bg-emerald-100"></span> å¦‚æœŸå®Œæˆ</span>
            <span className="inline-flex items-center gap-1"><span className="inline-block w-3 h-3 rounded border border-amber-300 bg-amber-100"></span> å»¶å®•</span>
            <span className="text-gray-400">é»ä¸€ä¸‹æ ¼å­å¯å¾ªç’°åˆ‡æ›ç‹€æ…‹</span>
          </div>

          <div className="overflow-auto mt-3">
            {loading ? (
              <div className="text-center text-gray-500 py-6">è¼‰å…¥ä¸­â€¦</div>
            ) : (
              <div style={{ minWidth: 800 }}>
                <div className="grid text-sm" style={{ gridTemplateColumns: '240px repeat(7, minmax(0, 1fr))' }}>
                  <div className="p-2 bg-gray-50 border">æœ¬é€±è¦åšä»€éº¼</div>
                  {days.map(function(d){ return <div key={toDateStr(d)} className="p-2 bg-gray-50 border text-center">{toDateStr(d)}</div>; })}

                  {rows.map(function(r){
                    return (
                      <React.Fragment key={r.id}>
                        <div className="border p-2 flex items-center gap-2">
                          <span className="cursor-grab select-none text-gray-300">â‹®â‹®</span>
                          <input className="flex-1 bg-transparent focus:outline-none" placeholder="ä¾‹å¦‚ï¼šé€±å ±ã€å®¢æˆ¶ç°¡å ±ã€ç ”ç©¶å ±å‘Šâ€¦" value={r.title} onChange={function(e){updateTitle(r.id, e.target.value);}} />
                          <button onClick={function(){delRow(r.id);}} className="text-xs text-red-600 hover:underline">åˆªé™¤</button>
                        </div>
                        {days.map(function(d){
                          const ds=toDateStr(d);
                          const cell=(r.daily && r.daily[ds]) ? r.daily[ds] : null;
                          const status=cell?cell.status:null;
                          return (
                            <div key={ds} className={"border p-2 "+statusClass(status||'none')+" transition"} onClick={function(){updateCell(r.id, ds, { status: cycleStatus(status||'none') });}}>
                              <textarea className="w-full h-16 resize-none bg-transparent focus:outline-none text-sm"
                                placeholder="é è¨ˆé€²åº¦/äº¤ä»˜â€¦ï¼ˆé»æ ¼å­åˆ‡æ›ç‹€æ…‹ï¼‰"
                                value={(cell && cell.plan) ? cell.plan : ""}
                                onChange={function(e){updateCell(r.id, ds, { plan: e.target.value });}}
                                onClick={function(e){ e.stopPropagation(); }} />
                            </div>
                          );
                        })}
                      </React.Fragment>
                    );
                  })}
                </div>

                <div className="mt-3">
                  <button onClick={addRow} className="px-3 py-2 rounded-xl bg-gray-800 text-white text-sm">æ–°å¢ä¸€åˆ—</button>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    // ===== æ—¥è¨˜å½ˆçª— =====
    function EntryModal({ date, onClose, onChanged, cryptoKey, readCustomStickers, writeCustomStickers }){
      const dateStr=toDateStr(date);
      const [text,setText]=useState(""), [images,setImages]=useState([]), [stickers,setStickers]=useState([]), [tasks,setTasks]=useState([]), [loading,setLoading]=useState(true), [saving,setSaving]=useState(false), [newTask,setNewTask]=useState(""), [libStickers,setLibStickers]=useState([]);

      useEffect(function(){ (async function(){
        try{
          const raw=localStorage.getItem(LS_PREFIX+dateStr);
          if(raw){ const obj=await decryptJSON(JSON.parse(raw), cryptoKey); setText(obj.text||""); setImages(Array.isArray(obj.images)?obj.images:[]); setStickers(Array.isArray(obj.stickers)?obj.stickers:[]); setTasks(Array.isArray(obj.tasks)?obj.tasks:[]); }
          if(readCustomStickers){ const tmp=await readCustomStickers(); setLibStickers(tmp); }
        }catch(e){ console.error(e); alert("è®€å–è³‡æ–™å¤±æ•—ï¼Œå¯èƒ½æ˜¯å¯†ç¢¼è®Šæ›´æˆ–è³‡æ–™ææ¯€ã€‚"); }
        finally{ setLoading(false); }
      })(); }, [dateStr, cryptoKey]);

      const onAddImages=async function(files){ const list=Array.prototype.slice.call(files||[]); const converted=[]; for(var i=0;i<list.length;i++){ converted.push(await fileToDataURLCompressed(list[i])); } setImages(function(prev){ return converted.concat(prev); }); };
      const onSave=async function(){ try{ setSaving(true); const payload=await encryptJSON({ text, images, stickers, tasks, lastModified:Date.now() }, cryptoKey); localStorage.setItem(LS_PREFIX+dateStr, JSON.stringify(payload)); onClose(); if(onChanged) onChanged(); }catch(e){ console.error(e); alert("å„²å­˜å¤±æ•—"); } finally{ setSaving(false);} };
      const onDelete=function(){ if(!confirm("åˆªé™¤æ­¤æ—¥æœŸçš„æ—¥è¨˜èˆ‡åœ–ç‰‡/å¾…è¾¦ï¼Ÿ")) return; localStorage.removeItem(LS_PREFIX+dateStr); onClose(); if(onChanged) onChanged(); };
      const addStickerEmoji=function(s){ setStickers(function(prev){ return [s].concat(prev); }); };
      const removeImage=function(idx){ setImages(function(prev){ return prev.filter(function(_,i){return i!==idx;}); }); };
      const removeSticker=function(idx){ setStickers(function(prev){ return prev.filter(function(_,i){return i!==idx;}); }); };
      const [dragId,setDragId]=useState(null);
      const addTask=function(){ const t=(newTask||"").trim(); if(!t) return; setTasks(function(prev){ return [{ id:Date.now()+Math.random(), text:t, done:false }].concat(prev); }); setNewTask(""); };
      const toggleTask=function(id){ setTasks(function(prev){ return prev.map(function(x){ return x.id===id?{...x, done:!x.done}:x; }); }); };
      const updateTaskText=function(id,text){ setTasks(function(prev){ return prev.map(function(x){ return x.id===id?{...x, text:text}:x; }); }); };
      const removeTask=function(id){ setTasks(function(prev){ return prev.filter(function(x){return x.id!==id;}); }); };
      const reorderTaskLocal=function(from,to){ setTasks(function(prev){ return reorderByIds(prev, from, to); }); };
      const onUploadStickers=async function(files){ const list=Array.prototype.slice.call(files||[]); const converted=[]; for(var i=0;i<list.length;i++){ converted.push(await fileToDataURLCompressed(list[i])); } const newLib=converted.concat(libStickers); setLibStickers(newLib); if(writeCustomStickers) await writeCustomStickers(newLib); };
      const deleteLibSticker=async function(idx){ const newLib=libStickers.filter(function(_,i){return i!==idx;}); setLibStickers(newLib); if(writeCustomStickers) await writeCustomStickers(newLib); };
      const useLibSticker=function(src){ setStickers(function(prev){ return [src].concat(prev); }); };
      const renderStickerItem=function(s,i){ const isImg=typeof s==='string' && s.indexOf('data:image')===0; return (<div key={i} className="relative">{isImg?(<img src={s} alt="sticker" className="w-12 h-12 object-contain" />):(<span className="text-3xl leading-none">{s}</span>)}<button onClick={function(){removeSticker(i);}} className="absolute -top-2 -right-2 bg-black/60 text-white text-xs rounded-full px-1">âœ•</button></div>); };

      return (
        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-end sm:items-center justify-center z-50">
          <div className="w-full sm:max-w-3xl bg-white rounded-t-2xl sm:rounded-2xl shadow-xl overflow-hidden flex flex-col svh90" style={{maxHeight:'90vh'}}>
            <div className="flex items-center justify-between px-4 sm:px-6 py-3 border-b shrink-0">
              <div className="font-semibold">{dateStr} çš„å¿ƒæƒ…</div>
              <button onClick={onClose} className="text-gray-500 hover:text-gray-700">âœ•</button>
            </div>
            <div className="flex-1 overflow-y-auto p-4 sm:p-6 space-y-6">
              {loading?(<div className="text-center text-gray-500">è¼‰å…¥ä¸­â€¦</div>):(
                <>
                  <section><label className="text-sm text-gray-600">æ–‡å­—å…§å®¹</label><textarea value={text} onChange={function(e){setText(e.target.value);}} rows={6} className="mt-1 w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-300" placeholder="ä»Šå¤©çš„å¿ƒæƒ…â‹¯â‹¯"/></section>
                  <section className="space-y-2"><div className="flex items-center justify-between"><div className="text-sm text-gray-600">ç…§ç‰‡</div><label className="px-3 py-1.5 rounded-lg bg-gray-100 text-sm cursor-pointer hover:bg-gray-200">æ–°å¢ç…§ç‰‡<input type="file" accept="image/*" multiple className="hidden" onChange={function(e){ if(e.target && e.target.files){ onAddImages(e.target.files); } }} /></label></div>{images.length===0?(<div className="text-xs text-gray-400">å°šæœªåŠ å…¥ç…§ç‰‡</div>):(<div className="grid grid-cols-3 sm:grid-cols-4 gap-2">{images.map(function(src,idx){ return (<div key={idx} className="relative group"><img src={src} alt="uploaded" className="w-full h-24 object-cover rounded-lg border" /><button onClick={function(){removeImage(idx);}} className="absolute top-1 right-1 bg-black/60 text-white text-xs px-1.5 py-0.5 rounded opacity-0 group-hover:opacity-100">åˆªé™¤</button></div>); })}</div>)}</section>
                  <section className="space-y-3"><div className="text-sm text-gray-600">å¯æ„›è²¼åœ–</div><div className="flex flex-wrap gap-2">{STICKERS.map(function(s){ return (<button key={s} onClick={function(){addStickerEmoji(s);}} className="text-2xl hover:scale-110 transition">{s}</button>); })}</div><div className="mt-2"><div className="flex items-center justify-between mb-2"><div className="text-sm text-gray-600">è‡ªè¨‚è²¼åœ–åº«ï¼ˆé»æ“Šå¯æ’å…¥ï¼‰</div><label className="px-3 py-1.5 rounded-lg bg-gray-100 text-sm cursor-pointer hover:bg-gray-200">ä¸Šå‚³è²¼åœ–<input type="file" accept="image/*" multiple className="hidden" onChange={async function(e){ if(e.target && e.target.files && e.target.files.length){ await onUploadStickers(e.target.files); } }} /></label></div>{libStickers.length?(<div className="grid grid-cols-6 sm:grid-cols-8 gap-2">{libStickers.map(function(src,idx){ return (<div key={idx} className="relative group"><img src={src} alt="sticker" className="w-12 h-12 object-contain border rounded-lg bg-white cursor-pointer" onClick={function(){useLibSticker(src);}} /><button onClick={function(){deleteLibSticker(idx);}} className="absolute -top-2 -right-2 bg-black/60 text-white text-[10px] rounded-full px-1 opacity-0 group-hover:opacity-100">âœ•</button></div>); })}</div>):(<div className="text-xs text-gray-400">å°šç„¡è‡ªè¨‚è²¼åœ–ï¼Œå…ˆä¸Šå‚³ PNG/JPG è©¦è©¦ï¼</div>)}</div>{stickers.length>0 && (<div className="flex flex-wrap gap-2 mt-2">{stickers.map(function(s,i){ return renderStickerItem(s,i); })}</div>)}</section>
                  <section className="space-y-2"><div className="text-sm text-gray-600">ç•¶æ—¥äº‹é …ï¼ˆå¯æ‰“å‹¾ï¼Œæ‹–æ‹‰æ’åºï¼‰</div><div className="flex items-center gap-2"><input value={newTask} onChange={function(e){setNewTask(e.target.value);}} onKeyDown={function(e){ if(e.key==='Enter') addTask(); }} placeholder="è¼¸å…¥å¾…è¾¦ï¼ŒEnter æ–°å¢" className="flex-1 border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-300" /><button onClick={addTask} className="px-3 py-2 rounded-xl bg-gray-800 text-white text-sm">æ–°å¢</button></div>{tasks.length>0?(<ul className="space-y-2">{tasks.map(function(t){ return (<li key={t.id} className="flex items-center gap-2 p-2 rounded-lg border bg-white" draggable onDragStart={function(){ setDragId(t.id); }} onDragOver={function(e){ e.preventDefault(); }} onDrop={function(){ if(dragId && dragId!==t.id) reorderTaskLocal(dragId, t.id); setDragId(null); }}><span className="cursor-grab select-none px-1 text-gray-400">â‹®â‹®</span><input type="checkbox" checked={!!t.done} onChange={function(){toggleTask(t.id);}} className="w-5 h-5" /><input className={"flex-1 bg-transparent focus:outline-none "+(t.done?"line-through text-gray-400":"")} value={t.text} onChange={function(e){updateTaskText(t.id, e.target.value);}} /><button onClick={function(){removeTask(t.id);}} className="text-xs text-red-600 hover:underline">åˆªé™¤</button></li>); })}</ul>):(<div className="text-xs text-gray-400">é‚„æ²’æœ‰äº‹é …ï¼Œå…ˆåŠ ä¸€å€‹å§ï¼</div>)}</section>
                </>
              )}
            </div>
            <div className="flex items-center justify-between px-4 sm:px-6 py-3 border-t bg-white/95 backdrop-blur sticky bottom-0 shrink-0">
              <button onClick={onDelete} className="px-3 py-2 rounded-xl bg-red-100 text-red-700 hover:bg-red-200">åˆªé™¤æ­¤æ—¥</button>
              <div className="flex items-center gap-2">
                <button onClick={onClose} className="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200">å–æ¶ˆ</button>
                <button onClick={onSave} disabled={saving} className="px-4 py-2 rounded-xl bg-pink-500 text-white hover:bg-pink-600 disabled:opacity-60">{saving?"å„²å­˜ä¸­â€¦":"å„²å­˜"}</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // ===== æ¨¡æ¿å½ˆçª— =====
    function TemplateModal({ onClose, templates, setTemplates, saveTemplates }){
      const [newItem,setNewItem]=useState(""), [dragIdx,setDragIdx]=useState(null);
      const add=function(){ const t=(newItem||"").trim(); if(!t) return; setTemplates(templates.concat([t])); setNewItem(""); };
      const del=function(i){ setTemplates(templates.filter(function(_,idx){ return idx!==i; })); };
      const update=function(i,v){ setTemplates(templates.map(function(x,idx){ return idx===i?v:x; })); };
      const reorder=function(from,to){ if(from===to || from==null || to==null) return; const arr=templates.slice(); const item=arr.splice(from,1)[0]; arr.splice(to,0,item); setTemplates(arr); };
      return (
        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50">
          <div className="w-full sm:max-w-lg bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col svh90" style={{maxHeight:'90vh'}}>
            <div className="flex items-center justify-between px-4 sm:px-6 py-3 border-b shrink-0"><div className="font-semibold">ç·¨è¼¯æ¯æ—¥æ¨¡æ¿</div><button onClick={onClose} className="text-gray-500 hover:text-gray-700">âœ•</button></div>
            <div className="flex-1 overflow-y-auto p-4 sm:p-6 space-y-4">
              <div className="flex items-center gap-2"><input value={newItem} onChange={function(e){setNewItem(e.target.value);}} onKeyDown={function(e){ if(e.key==='Enter') add(); }} placeholder="è¼¸å…¥æ¨¡æ¿é …ç›®ï¼ŒEnter æ–°å¢" className="flex-1 border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-300" /><button onClick={add} className="px-3 py-2 rounded-xl bg-emerald-500 textç™½ text-sm" style="color:white">æ–°å¢</button></div>
              {templates && templates.length ? (
                <ul className="space-y-2">
                  {templates.map(function(t,i){
                    return (
                      <li key={i} className="flex items-center gap-2 p-2 rounded-lg border bgç™½" style="background:white"
                          draggable
                          onDragStart={function(){ setDragIdx(i); }}
                          onDragOver={function(e){ e.preventDefault(); }}
                          onDrop={function(){ if(dragIdx!=null && dragIdx!==i) reorder(dragIdx,i); setDragIdx(null); }}>
                        <span className="cursor-grab select-none px-1 text-gray-400">â‹®â‹®</span>
                        <input className="flex-1 bg-transparent focus:outline-none" value={t} onChange={function(e){update(i, e.target.value);}} />
                        <button onClick={function(){del(i);}} className="text-xs text-red-600 hover:underline">åˆªé™¤</button>
                      </li>
                    );
                  })}
                </ul>
              ) : (
                <div className="text-xs text-gray-400">é‚„æ²’æœ‰æ¨¡æ¿ï¼Œå…ˆæ–°å¢å¹¾å€‹å¸¸ç”¨é …ç›®å§ï¼ˆä¾‹å¦‚ï¼šå– 2000ml æ°´ã€30 åˆ†é˜é‹å‹•ã€é–±è®€ 20 åˆ†é˜â‹¯â‹¯ï¼‰ã€‚</div>
              )}
            </div>
            <div className="flex items-center justify-end gap-2 px-4 sm:px-6 py-3 border-t bg-white/95 backdrop-blur sticky bottom-0 shrink-0">
              <button onClick={onClose} className="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200">å–æ¶ˆ</button>
              <button onClick={async function(){ await saveTemplates(templates); onClose(); }} className="px-4 py-2 rounded-xl bg-emerald-500 textç™½ hover:bg-emerald-600" style="color:white">å„²å­˜æ¨¡æ¿</button>
            </div>
          </div>
        </div>
      );
    }

    // ===== ä¸» App =====
    function DiaryApp({ monthDate, setMonthDate, selectedDate, setSelectedDate, cryptoKey, logout, resetAll }){
      const year=monthDate.getFullYear(), month=monthDate.getMonth();
      const cells=useMemo(function(){ return getMonthMatrix(year, month); }, [year, month]);
      const [refreshKey,setRefreshKey]=useState(0);

      // æœ¬æœˆå“ªäº›æ—¥å­æœ‰æ—¥è¨˜
      const entryMap=useMemo(function(){ const map=new Set(); const daysInMonth=new Date(year, month+1, 0).getDate(); for(let d=1; d<=daysInMonth; d++){ const k=LS_PREFIX + year + "-" + String(month+1).padStart(2,"0") + "-" + String(d).padStart(2,"0"); if(localStorage.getItem(k)) map.add(d); } return map; }, [year, month, selectedDate, refreshKey]);

      const today=new Date(); const todayStr=toDateStr(today);

      // è®€å¯«æ¯æ—¥æ¢ç›®ï¼ˆåŠ å¯†ï¼‰
      const readEntry=async function(dateStr){ const raw=localStorage.getItem(LS_PREFIX+dateStr); if(!raw) return null; const payload=JSON.parse(raw); const obj=await decryptJSON(payload, cryptoKey); if(!Array.isArray(obj.tasks)) obj.tasks=[]; if(!Array.isArray(obj.images)) obj.images=[]; if(!Array.isArray(obj.stickers)) obj.stickers=[]; return obj; };
      const writeEntry=async function(dateStr,obj){ const payload=await encryptJSON(obj, cryptoKey); localStorage.setItem(LS_PREFIX+dateStr, JSON.stringify(payload)); setRefreshKey(function(v){return v+1;}); };

      // æ¨¡æ¿ / è‡ªè¨‚è²¼åœ–åº«
      const readTemplates=async function(){ const raw=localStorage.getItem(LS_TEMPLATES); if(!raw) return []; try{ return await decryptJSON(JSON.parse(raw), cryptoKey); }catch(e){ return []; } };
      const writeTemplates=async function(arr){ const payload=await encryptJSON(arr, cryptoKey); localStorage.setItem(LS_TEMPLATES, JSON.stringify(payload)); };
      const readCustomStickers=async function(){ const raw=localStorage.getItem(LS_CSTICKERS); if(!raw) return []; try{ return await decryptJSON(JSON.parse(raw), cryptoKey); }catch(e){ return []; } };
      const writeCustomStickers=async function(arr){ const payload=await encryptJSON(arr, cryptoKey); localStorage.setItem(LS_CSTICKERS, JSON.stringify(payload)); };

      // åŒ¯å‡º/åŒ¯å…¥
      const importRef=useRef(null);
      const exportBackup=function(){ const data={}; Object.keys(localStorage).forEach(function(k){ if(k.indexOf(LS_PREFIX)===0) data[k]=localStorage.getItem(k); }); const blob=new Blob([JSON.stringify({_meta:{when:new Date().toISOString()}, data}, null, 2)], {type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="mood-diary-backup-"+Date.now()+".json"; a.click(); URL.revokeObjectURL(url); };
      const importBackup=async function(file){ try{ const text=await file.text(); const parsed=JSON.parse(text); if(!parsed||!parsed.data||typeof parsed.data!=="object") throw new Error("æ ¼å¼éŒ¯èª¤"); if(!confirm("åŒ¯å…¥å°‡è¦†è“‹ç¾æœ‰ç›¸åŒéµå€¼çš„è³‡æ–™ï¼Œç¹¼çºŒå—ï¼Ÿ")) return; for(const k in parsed.data){ localStorage.setItem(k, parsed.data[k]); } alert("åŒ¯å…¥æˆåŠŸã€‚"); setRefreshKey(function(v){return v+1;}); refreshToday(); refreshOverdue(); loadTemplates(); setBoardRefreshKey(function(v){return v+1;}); }catch(e){ console.error(e); alert("åŒ¯å…¥å¤±æ•—ï¼šæ ¼å¼ä¸æ­£ç¢ºæˆ–æª”æ¡ˆææ¯€ã€‚"); } };

      // ä»Šå¤©å¾…è¾¦
      const [todayTasks,setTodayTasks]=useState([]); const [newTaskText,setNewTaskText]=useState("");
      const refreshToday=async function(){ const obj=await readEntry(todayStr); setTodayTasks((obj&&obj.tasks)||[]); };
      useEffect(function(){ refreshToday(); }, [cryptoKey]);
      const mutateToday=async function(mutator){ const base=await readEntry(todayStr); const obj = base || { text:"", images:[], stickers:[], tasks:[], lastModified:Date.now() }; const newObj=mutator({ ...obj, tasks:Array.isArray(obj.tasks)?obj.tasks:[] }); newObj.lastModified=Date.now(); await writeEntry(todayStr, newObj); setTodayTasks(newObj.tasks); };
      const addTodayTask=async function(){ const t=(newTaskText||"").trim(); if(!t) return; await mutateToday(function(o){ return { ...o, tasks:[{id:Date.now()+Math.random(), text:t, done:false}].concat(o.tasks) }; }); setNewTaskText(""); };
      const toggleTodayTask=async function(id){ await mutateToday(function(o){ return { ...o, tasks:o.tasks.map(function(it){ return it.id===id?{...it, done:!it.done}:it; }) }; }); };
      const updateTodayTaskText=async function(id,text){ await mutateToday(function(o){ return { ...o, tasks:o.tasks.map(function(it){ return it.id===id?{...it, text:text}:it; }) }; }); };
      const removeTodayTask=async function(id){ await mutateToday(function(o){ return { ...o, tasks:o.tasks.filter(function(it){return it.id!==id;}) }; }); };
      const reorderTodayTasks=async function(fromId,toId){ await mutateToday(function(o){ return { ...o, tasks:reorderByIds(o.tasks, fromId, toId) }; }); };

      // é€¾æœŸ/è·¨æ—¥
      const [overdue,setOverdue]=useState([]);
      const refreshOverdue=async function(){ const list=[]; for(let i=1;i<=7;i++){ const d=new Date(today); d.setDate(today.getDate()-i); const ds=toDateStr(d); const o=await readEntry(ds); if(o && o.tasks && o.tasks.length){ for(let j=0;j<o.tasks.length;j++){ const t=o.tasks[j]; if(!t.done) list.push({ dateStr:ds, id:t.id, text:t.text }); } } } setOverdue(list); };
      useEffect(function(){ refreshOverdue(); }, [cryptoKey, refreshKey]);
      const carryOneToToday=async function(item, alsoComplete){ if(typeof alsoComplete==="undefined") alsoComplete=true; await mutateToday(function(o){ return { ...o, tasks:[{id:Date.now()+Math.random(), text:item.text, done:false}].concat(o.tasks) }; }); if(alsoComplete){ const src=await readEntry(item.dateStr); if(src){ src.tasks=src.tasks.map(function(x){ return x.id===item.id?{...x, done:true}:x; }); src.lastModified=Date.now(); await writeEntry(item.dateStr, src); } } refreshOverdue(); };
      const carryAllOverdue=async function(alsoComplete){ if(typeof alsoComplete==="undefined") alsoComplete=true; for(let i=0;i<overdue.length;i++){ await carryOneToToday(overdue[i], alsoComplete); } };

      // æ¨¡æ¿
      const [templates,setTemplates]=useState([]); const [templateOpen,setTemplateOpen]=useState(false);
      const loadTemplates=async function(){ setTemplates(await readTemplates()); };
      useEffect(function(){ loadTemplates(); }, [cryptoKey]);
      const applyTemplatesToToday=async function(){ if(!templates.length) { alert("ç›®å‰æ²’æœ‰æ¨¡æ¿é …ç›®ï¼Œå¯å…ˆåˆ°ã€ç·¨è¼¯æ¨¡æ¿ã€æ–°å¢ã€‚"); return; } await mutateToday(function(o){ return { ...o, tasks: templates.map(function(t){ return {id:Date.now()+Math.random(), text:t, done:false}; }).concat(o.tasks) }; }); };

      // é€±çœ‹æ¿ç‹€æ…‹é¡¯ç¤ºåˆ°æœˆæ›†
      const [weeklyBadgeMap, setWeeklyBadgeMap] = useState(new Map());
      const [boardRefreshKey, setBoardRefreshKey] = useState(0);
      useEffect(function(){
        (async function(){
          const newMap = new Map();
          const daysInMonth = new Date(year, month+1, 0).getDate();
          const mondayKeys = new Set();
          for(let d=1; d<=daysInMonth; d++){ const date = new Date(year, month, d); mondayKeys.add(toDateStr(getMonday(date))); }
          const PRIORITY = { plan:1, delay:2, done:3 };
          const weekCache = new Map();
          mondayKeys.forEach(function(monStr){
            const raw = localStorage.getItem(LS_PREFIX+"board_"+monStr);
            if(!raw) return;
            try{
              const obj = JSON.parse(raw);
              weekCache.set(monStr, obj);
            }catch(e){}
          });

          const mergedByMonday = new Map();
          for(const monStr of mondayKeys){
            const raw = localStorage.getItem(LS_PREFIX+"board_"+monStr);
            if(!raw) continue;
            try{
              const obj = await decryptJSON(JSON.parse(raw), cryptoKey);
              const rows = Array.isArray(obj.rows)? obj.rows : [];
              const byDay = new Map();
              for(let i=0;i<rows.length;i++){
                const r = rows[i];
                if(!r || !r.daily) continue;
                for(const ds in r.daily){
                  const cell = r.daily[ds];
                  const s = cell && cell.status;
                  if(!s) continue;
                  const prev = byDay.get(ds);
                  if(!prev || PRIORITY[s] > PRIORITY[prev]) byDay.set(ds, s);
                }
              }
              mergedByMonday.set(monStr, byDay);
            }catch(e){}
          }

          for(let d=1; d<=daysInMonth; d++){
            const date = new Date(year, month, d);
            const ds = toDateStr(date);
            const monStr = toDateStr(getMonday(date));
            const byDay = mergedByMonday.get(monStr);
            const s = byDay && byDay.get(ds);
            if(s) newMap.set(d, s);
          }
          setWeeklyBadgeMap(newMap);
        })();
      }, [cryptoKey, year, month, boardRefreshKey]);

      // æœˆæ›†å°è¦½/æ‰“é–‹æ—¥è¨˜
      const goPrev = function(){ setMonthDate(new Date(year, month-1, 1)); };
      const goNext = function(){ setMonthDate(new Date(year, month+1, 1)); };
      const openDay = function(d){ setSelectedDate(d); };
      const openToday = function(){ setSelectedDate(new Date()); };

      // in-app æé†’
      const inApp = /(FBAN|FBAV|Instagram|Line\/)/i.test(navigator.userAgent || "");
      const isStandalone = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || (window.navigator && window.navigator.standalone);

      return (
        <div className="min-h-screen bg-gradient-to-b from-white to-pink-50 p-4 sm:p-8">
          <div className="mx-auto max-w-5xl">
            {(inApp || isStandalone) && (
              <div className="mb-3 text-xs text-amber-800 bg-amber-50 border border-amber-200 rounded-xl p-2">
                åµæ¸¬åˆ°ä½ å¯èƒ½åœ¨ App å…§å»ºç€è¦½å™¨æˆ–ä¸»ç•«é¢ App æ¨¡å¼ã€‚è‹¥ç„¡æ³•é¸æ“‡æª”æ¡ˆï¼Œè«‹åœ¨ Safari ä¸­é–‹å•Ÿæ­¤ç¶²ç«™å¾Œå†è©¦ï¼ˆåˆ†äº« â†’ åœ¨ Safari æ‰“é–‹ï¼‰ã€‚
              </div>
            )}

            <header className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
              <div>
                <h1 className="text-2xl sm:text-3xl font-bold">å¿ƒæƒ…æ—¥è¨˜</h1>
                <p className="text-xs text-gray-500 mt-1">ğŸ” å·²åŠ å¯† Â· å„²å­˜åœ¨æ­¤ç€è¦½å™¨</p>
              </div>
              <div className="flex flex-wrap items-center gap-2">
                <button onClick={exportBackup} className="px-3 py-2 rounded-xl bg-gray-800 text-white text-sm hover:opacity-90">å‚™ä»½</button>
                <button onClick={function(){ if(importRef.current) importRef.current.click(); }} className="px-3 py-2 rounded-xl bg-gray-200 text-sm hover:opacity-90">åŒ¯å…¥</button>
                <input ref={importRef} type="file" accept="application/json" className="hidden" onChange={function(e){ if(e && e.target && e.target.files && e.target.files[0]) importBackup(e.target.files[0]); }} />
                <button onClick={applyTemplatesToToday} className="px-3 py-2 rounded-xl bg-emerald-500 text-white text-sm hover:bg-emerald-600">å¥—ç”¨æ¨¡æ¿åˆ°ä»Šå¤©</button>
                <button onClick={function(){ setTemplateOpen(true); }} className="px-3 py-2 rounded-xl bg-emerald-100 text-emerald-800 text-sm hover:bg-emerald-200">ç·¨è¼¯æ¨¡æ¿</button>
                <button onClick={openToday} className="px-3 py-2 rounded-xl bg-pink-500 text-white text-sm hover:bg-pink-600">ä»Šå¤©æ—¥è¨˜</button>
                <button onClick={logout} className="px-3 py-2 rounded-xl bg-purple-500 textç™½ text-sm hover:bg-purple-600" style="color:white">ç™»å‡º</button>
                <button onClick={resetAll} className="px-3 py-2 rounded-xl bg-red-500 textç™½ text-sm hover:bg-red-600" style="color:white">é‡è¨­ï¼ˆæ¸…ç©ºï¼‰</button>
              </div>
            </header>

            {/* ä»Šå¤©å¾…è¾¦ */}
            <TodayTasksCard
              dateStr={todayStr}
              tasks={todayTasks}
              newTaskText={newTaskText}
              setNewTaskText={setNewTaskText}
              addTask={addTodayTask}
              toggleTask={toggleTodayTask}
              updateTaskText={updateTodayTaskText}
              removeTask={removeTodayTask}
              reorderTasks={reorderTodayTasks}
              openToday={openToday}
            />

            {/* é€¾æœŸ/è·¨æ—¥ */}
            <OverdueCard overdue={overdue} carryOne={carryOneToToday} carryAll={carryAllOverdue} />

            {/* é€±çœ‹æ¿ï¼ˆå°ˆæ¡ˆï¼‰å¸¸é§ */}
            <WeeklyBoardSection cryptoKey={cryptoKey} onChanged={function(){ setBoardRefreshKey(function(v){return v+1;}); }} />

            {/* æœˆæ›† */}
            <div className="bg-white/80 backdrop-blur rounded-2xl shadow p-4 sm:p-6 mt-4">
              <div className="flex items-center justify-between mb-4">
                <button onClick={goPrev} className="px-3 py-1.5 rounded-lg bg-gray-100 hover:bg-gray-200">â† ä¸Šå€‹æœˆ</button>
                <div className="font-semibold text-lg">{year} å¹´ {month + 1} æœˆ</div>
                <button onClick={goNext} className="px-3 py-1.5 rounded-lg bg-gray-100 hover:bg-gray-200">ä¸‹å€‹æœˆ â†’</button>
              </div>
              <CalendarGrid cells={cells} entryMap={entryMap} weeklyBadgeMap={weeklyBadgeMap} todayStr={todayStr} onPick={openDay} />
            </div>

            {/* å½ˆçª—å€‘ */}
            {selectedDate && (
              <EntryModal
                date={selectedDate}
                onClose={function(){ setSelectedDate(null); }}
                onChanged={function(){ if(toDateStr(selectedDate)===todayStr) refreshToday(); setRefreshKey(function(v){return v+1;}); refreshOverdue(); }}
                cryptoKey={cryptoKey}
                readCustomStickers={readCustomStickers}
                writeCustomStickers={writeCustomStickers}
              />
            )}
            {templateOpen && (
              <TemplateModal
                onClose={function(){ setTemplateOpen(false); }}
                templates={templates}
                setTemplates={setTemplates}
                saveTemplates={async function(arr){ await writeTemplates(arr); setTemplates(arr); }}
              />
            )}

            <footer className="text-center text-xs text-gray-400 mt-6">
              <p>å°æé†’ï¼šå¤§é‡ç…§ç‰‡/è²¼åœ–æœƒä½”ç”¨ç€è¦½å™¨ç©ºé–“ï¼Œå»ºè­°ä¸å®šæœŸå‚™ä»½èˆ‡æ¸…ç†ã€‚</p>
            </footer>
          </div>
        </div>
      );
    }

    // ===== æ®¼å±¤ï¼šç™»å…¥/è§£é– =====
    function DiaryShell(){
      const [unlocked,setUnlocked]=useState(false);
      const [cryptoKey,setCryptoKey]=useState(null);
      const [monthDate,setMonthDate]=useState(new Date());
      const [selectedDate,setSelectedDate]=useState(null);
      const [hasVerifier,setHasVerifier]=useState(false);

      useEffect(function(){ setHasVerifier(Boolean(localStorage.getItem(LS_SALT) && localStorage.getItem(LS_VERIFIER))); },[]);
      const handleSetPassword=async function(pwd){ const obj=await deriveKey(pwd,null); const key=obj.key, saltB64=obj.saltB64; const verifierPayload=await encryptJSON({v:"ok"}, key); localStorage.setItem(LS_SALT, saltB64); localStorage.setItem(LS_VERIFIER, JSON.stringify(verifierPayload)); setHasVerifier(true); setCryptoKey(key); setUnlocked(true); };
      const handleUnlock=async function(pwd){ try{ const saltB64=localStorage.getItem(LS_SALT); const key=(await deriveKey(pwd, saltB64)).key; const verifierPayload=JSON.parse(localStorage.getItem(LS_VERIFIER)); const res=await decryptJSON(verifierPayload, key); if(res && res.v==="ok"){ setCryptoKey(key); setUnlocked(true); } else alert("å¯†ç¢¼éŒ¯èª¤"); }catch(e){ console.error(e); alert("å¯†ç¢¼éŒ¯èª¤æˆ–è³‡æ–™å·²ææ¯€ã€‚"); } };
      const logout=function(){ setUnlocked(false); setCryptoKey(null); };
      const resetAll=function(){ if(!confirm("âš ï¸ å°‡æ¸…ç©ºæ‰€æœ‰æ—¥è¨˜è³‡æ–™èˆ‡å¯†ç¢¼è¨­å®šï¼Œä¸”ç„¡æ³•å¾©åŸã€‚ç¢ºå®šå—ï¼Ÿ")) return; Object.keys(localStorage).filter(function(k){return k.indexOf(LS_PREFIX)===0;}).forEach(function(k){ localStorage.removeItem(k); }); setUnlocked(false); setCryptoKey(null); alert("å·²æ¸…ç©ºã€‚é‡æ–°æ•´ç†å¾Œå¯é‡æ–°è¨­å®šå¯†ç¢¼ã€‚"); };

      if(!unlocked){
        return (
          <div className="min-h-screen bg-gradient-to-b from-pink-50 to-purple-50 flex items-center justify-center p-6">
            <div className="w-full max-w-md bg-white/80 backdrop-blur shadow-xl rounded-2xl p-6">
              <div className="text-center mb-6">
                <div className="text-3xl font-bold">å¿ƒæƒ…æ—¥è¨˜</div>
                <div className="text-sm text-gray-500 mt-1">æœ¬æ©ŸåŠ å¯†å„²å­˜ Â· ç§å¯†ä¿è­·</div>
              </div>
              {hasVerifier?(<UnlockForm onUnlock={handleUnlock} />):(<SetPasswordForm onSet={handleSetPassword} />)}
              <div className="mt-6 text-xs text-gray-500 leading-relaxed">
                <p>æç¤ºï¼šæ­¤æ‡‰ç”¨å°‡å…§å®¹åŠ å¯†å¾Œå­˜æ–¼ä½ çš„ç€è¦½å™¨ <code>localStorage</code>ã€‚æ›é›»è…¦/æ¸…é™¤ç€è¦½å™¨è³‡æ–™æœƒéºå¤±å…§å®¹ï¼Œå»ºè­°å®šæœŸã€Œå‚™ä»½ã€ã€‚</p>
                <p className="mt-1">å¿˜è¨˜å¯†ç¢¼ç„¡æ³•å¾©åŸï¼Œè«‹å¦¥å–„ä¿ç®¡ã€‚</p>
              </div>
            </div>
          </div>
        );
      }

      return (<DiaryApp monthDate={monthDate} setMonthDate={setMonthDate} selectedDate={selectedDate} setSelectedDate={setSelectedDate} cryptoKey={cryptoKey} logout={logout} resetAll={resetAll} />);
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<DiaryShell />);
  </script>
</body>
</html>
