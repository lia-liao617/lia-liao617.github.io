import React, { useEffect, useMemo, useRef, useState } from "react";

// ---------------------------------------------
// å¿ƒæƒ…æ—¥è¨˜ï¼šå–®é  Web Appï¼ˆæœ¬æ©Ÿå„²å­˜ï¼‹å¯†ç¢¼åŠ å¯†ï¼‰
// åŠŸèƒ½ï¼šæœˆæ›†ã€æ–‡å­—ã€ç…§ç‰‡ã€å¯æ„›è²¼åœ–ã€ä»Šæ—¥å¾…è¾¦
// æ–°å¢ï¼ˆæœ¬æ¬¡ï¼‰ï¼š
// 1) å¾…è¾¦ã€Œæ‹–æ‹‰æ’åºã€
// 2) é€¾æœŸ/è·¨æ—¥æé†’ï¼ˆå¯ä¸€éµå¸¶åˆ°ä»Šå¤©ï¼Œä¸¦å¯åŒæ™‚æŠŠåŸä»»å‹™æ¨™è¨˜å®Œæˆï¼‰
// 3) æ¯æ—¥é‡è¤‡ã€Œæ¨¡æ¿ã€ï¼šå¯ç·¨è¼¯æ¨¡æ¿ä¸¦ä¸€éµå¥—ç”¨åˆ°ä»Šå¤©
// 4) ä»Šæ—¥å®Œæˆç‡ã€Œå°åœ“é¤…åœ–ã€
// 5) è‡ªè¨‚è²¼åœ–åº«ï¼šå¯ä¸Šå‚³æ›´å¤šè²¼åœ–ï¼Œåœ¨æ—¥è¨˜è¦–çª—ç›´æ¥ä½¿ç”¨
// ---------------------------------------------

// å·¥å…·ï¼šBase64 <-> ArrayBuffer
const ab2b64 = (buffer) => {
  const bytes = new Uint8Array(buffer);
  let binary = "";
  for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
  return btoa(binary);
};
const b642ab = (b64) => {
  const binary = atob(b64);
  const bytes = new Uint8Array(binary.length);
  for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
  return bytes.buffer;
};

// å·¥å…·ï¼šWebCrypto - è¡ç”Ÿé‡‘é‘°èˆ‡åŠ è§£å¯†
const textEncoder = new TextEncoder();
const textDecoder = new TextDecoder();

async function deriveKey(password, saltB64) {
  const salt = saltB64 ? new Uint8Array(b642ab(saltB64)) : crypto.getRandomValues(new Uint8Array(16));
  const baseKey = await crypto.subtle.importKey(
    "raw",
    textEncoder.encode(password),
    "PBKDF2",
    false,
    ["deriveKey"]
  );
  const aesKey = await crypto.subtle.deriveKey(
    { name: "PBKDF2", salt, iterations: 250_000, hash: "SHA-256" },
    baseKey,
    { name: "AES-GCM", length: 256 },
    false,
    ["encrypt", "decrypt"]
  );
  return { key: aesKey, saltB64: ab2b64(salt) };
}

async function encryptJSON(obj, key) {
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const plaintext = textEncoder.encode(JSON.stringify(obj));
  const ciphertext = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, key, plaintext);
  return { iv: ab2b64(iv), data: ab2b64(ciphertext) };
}

async function decryptJSON(payload, key) {
  const { iv, data } = payload;
  const ivArr = new Uint8Array(b642ab(iv));
  const cipherAB = b642ab(data);
  const plaintextAB = await crypto.subtle.decrypt({ name: "AES-GCM", iv: ivArr }, key, cipherAB);
  const plaintext = textDecoder.decode(plaintextAB);
  return JSON.parse(plaintext);
}

// å„²å­˜ Key å‰ç¶´
const LS_PREFIX = "moodDiary_";
const LS_SALT = `${LS_PREFIX}salt`;
const LS_VERIFIER = `${LS_PREFIX}verifier`;
const LS_TEMPLATES = `${LS_PREFIX}templates`;
const LS_CSTICKERS = `${LS_PREFIX}cstickers`;

// æ—¥æœŸå·¥å…·
function toDateStr(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

function getMonthMatrix(year, month /* 0~11 */) {
  const first = new Date(year, month, 1);
  const firstDay = first.getDay(); // 0(æ—¥)~6(å…­)
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  const cells = [];
  for (let i = 0; i < firstDay; i++) cells.push(null); // å‰ç½®ç©ºç™½
  for (let d = 1; d <= daysInMonth; d++) cells.push(new Date(year, month, d)); // æœ¬æœˆ
  while (cells.length % 7 !== 0) cells.push(null); // å¡«æ»¿ 6x7
  while (cells.length < 42) cells.push(null);
  return cells;
}

// å£“ç¸®ä¸Šå‚³åœ–ç‰‡ï¼ˆå¯¬/é«˜æœ€å¤§ 1600pxï¼‰ï¼Œä¿ç•™ PNG é€æ˜
async function fileToDataURLCompressed(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement("canvas");
        let { width, height } = img;
        const max = 1600;
        if (width > height && width > max) {
          height = Math.round((height * max) / width);
          width = max;
        } else if (height > max) {
          width = Math.round((width * max) / height);
          height = max;
        }
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, width, height);
        const isPng = file.type.includes("png");
        const dataUrl = canvas.toDataURL(isPng ? "image/png" : "image/jpeg", isPng ? 0.92 : 0.85);
        resolve(dataUrl);
      };
      img.onerror = reject;
      img.src = reader.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// é è¨­è²¼åœ–ï¼ˆå¯æ„› emojiï¼‰
const STICKERS = ["ğŸ»", "ğŸ°", "ğŸ±", "ğŸŒ¸", "ğŸ“", "âœ¨", "ğŸ’–", "ğŸ§‹", "ğŸ°", "â­", "ğŸ«¶", "ğŸ˜»", "ğŸ€", "ğŸŒˆ", "ğŸ€", "ğŸ¥", "ğŸ§¸", "â˜ï¸", "ğŸŒ¼"];

// å°å·¥å…·
const reorderByIds = (list, fromId, toId) => {
  const a = list.findIndex((x) => x.id === fromId);
  const b = list.findIndex((x) => x.id === toId);
  if (a === -1 || b === -1 || a === b) return list;
  const copy = [...list];
  const [item] = copy.splice(a, 1);
  copy.splice(b, 0, item);
  return copy;
};

// ä¸»è¦å…ƒä»¶
export default function App() {
  const [unlocked, setUnlocked] = useState(false);
  const [cryptoKey, setCryptoKey] = useState(null);
  const [monthDate, setMonthDate] = useState(new Date());
  const [selectedDate, setSelectedDate] = useState(null);
  const [hasVerifier, setHasVerifier] = useState(false);

  useEffect(() => {
    setHasVerifier(Boolean(localStorage.getItem(LS_SALT) && localStorage.getItem(LS_VERIFIER)));
  }, []);

  const handleSetPassword = async (pwd) => {
    const { key, saltB64 } = await deriveKey(pwd, null);
    const verifierPayload = await encryptJSON({ v: "ok" }, key);
    localStorage.setItem(LS_SALT, saltB64);
    localStorage.setItem(LS_VERIFIER, JSON.stringify(verifierPayload));
    setHasVerifier(true);
    setCryptoKey(key);
    setUnlocked(true);
  };

  const handleUnlock = async (pwd) => {
    try {
      const saltB64 = localStorage.getItem(LS_SALT);
      const { key } = await deriveKey(pwd, saltB64);
      const verifierPayload = JSON.parse(localStorage.getItem(LS_VERIFIER));
      const res = await decryptJSON(verifierPayload, key);
      if (res?.v === "ok") {
        setCryptoKey(key);
        setUnlocked(true);
      } else {
        alert("å¯†ç¢¼éŒ¯èª¤");
      }
    } catch (e) {
      console.error(e);
      alert("å¯†ç¢¼éŒ¯èª¤æˆ–è³‡æ–™å·²ææ¯€ã€‚");
    }
  };

  const logout = () => {
    setUnlocked(false);
    setCryptoKey(null);
  };

  const resetAll = () => {
    if (!confirm("âš ï¸ å°‡æ¸…ç©ºæ‰€æœ‰æ—¥è¨˜è³‡æ–™èˆ‡å¯†ç¢¼è¨­å®šï¼Œä¸”ç„¡æ³•å¾©åŸã€‚ç¢ºå®šå—ï¼Ÿ")) return;
    Object.keys(localStorage)
      .filter((k) => k.startsWith(LS_PREFIX))
      .forEach((k) => localStorage.removeItem(k));
    setUnlocked(false);
    setCryptoKey(null);
    setHasVerifier(false);
    alert("å·²æ¸…ç©ºã€‚é‡æ–°æ•´ç†å¾Œå¯é‡æ–°è¨­å®šå¯†ç¢¼ã€‚");
  };

  if (!unlocked) {
    return (
      <div className="min-h-screen bg-gradient-to-b from-pink-50 to-purple-50 flex items-center justify-center p-6">
        <div className="w-full max-w-md bg-white/80 backdrop-blur shadow-xl rounded-2xl p-6">
          <div className="text-center mb-6">
            <div className="text-3xl font-bold">å¿ƒæƒ…æ—¥è¨˜</div>
            <div className="text-sm text-gray-500 mt-1">æœ¬æ©ŸåŠ å¯†å„²å­˜ Â· ç§å¯†ä¿è­·</div>
          </div>
          {hasVerifier ? (
            <UnlockForm onUnlock={handleUnlock} />
          ) : (
            <SetPasswordForm onSet={handleSetPassword} />
          )}
          <div className="mt-6 text-xs text-gray-500 leading-relaxed">
            <p>æç¤ºï¼šæ­¤æ‡‰ç”¨å°‡å…§å®¹åŠ å¯†å¾Œå­˜æ–¼ä½ çš„ç€è¦½å™¨ <code>localStorage</code>ã€‚æ›é›»è…¦/æ¸…é™¤ç€è¦½å™¨è³‡æ–™æœƒéºå¤±å…§å®¹ï¼Œå»ºè­°å®šæœŸã€Œå‚™ä»½ã€ã€‚</p>
            <p className="mt-1">å¿˜è¨˜å¯†ç¢¼ç„¡æ³•å¾©åŸï¼Œè«‹å¦¥å–„ä¿ç®¡ã€‚</p>
          </div>
        </div>
      </div>
    );
  }

  return (
    <DiaryApp
      monthDate={monthDate}
      setMonthDate={setMonthDate}
      selectedDate={selectedDate}
      setSelectedDate={setSelectedDate}
      cryptoKey={cryptoKey}
      logout={logout}
      resetAll={resetAll}
    />
  );
}

function SetPasswordForm({ onSet }) {
  const [p1, setP1] = useState("");
  const [p2, setP2] = useState("");
  const [show, setShow] = useState(false);
  const submit = async (e) => {
    e.preventDefault();
    if (p1.length < 6) {
      alert("è«‹è‡³å°‘ 6 ç¢¼å¯†ç¢¼");
      return;
    }
    if (p1 !== p2) {
      alert("å…©æ¬¡è¼¸å…¥ä¸ä¸€è‡´");
      return;
    }
    await onSet(p1);
  };
  return (
    <form onSubmit={submit} className="space-y-4">
      <div>
        <label className="text-sm text-gray-600">è¨­å®šå¯†ç¢¼</label>
        <input type={show ? "text" : "password"} className="mt-1 w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-300" value={p1} onChange={(e) => setP1(e.target.value)} placeholder="è‡³å°‘ 6 ç¢¼" />
      </div>
      <div>
        <label className="text-sm text-gray-600">å†æ¬¡è¼¸å…¥å¯†ç¢¼</label>
        <input type={show ? "text" : "password"} className="mt-1 w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-300" value={p2} onChange={(e) => setP2(e.target.value)} />
      </div>
      <div className="flex items-center gap-2 text-sm">
        <input id="showPwd" type="checkbox" checked={show} onChange={(e) => setShow(e.target.checked)} />
        <label htmlFor="showPwd">é¡¯ç¤ºå¯†ç¢¼</label>
      </div>
      <button className="w-full bg-pink-500 hover:bg-pink-600 text-white rounded-xl py-2 font-semibold">è¨­å®šä¸¦é€²å…¥</button>
    </form>
  );
}

function UnlockForm({ onUnlock }) {
  const [pwd, setPwd] = useState("");
  const [show, setShow] = useState(false);
  const submit = async (e) => {
    e.preventDefault();
    await onUnlock(pwd);
  };
  return (
    <form onSubmit={submit} className="space-y-4">
      <div>
        <label className="text-sm text-gray-600">è¼¸å…¥å¯†ç¢¼</label>
        <input type={show ? "text" : "password"} className="mt-1 w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-300" value={pwd} onChange={(e) => setPwd(e.target.value)} />
      </div>
      <div className="flex items-center gap-2 text-sm">
        <input id="showPwd2" type="checkbox" checked={show} onChange={(e) => setShow(e.target.checked)} />
        <label htmlFor="showPwd2">é¡¯ç¤ºå¯†ç¢¼</label>
      </div>
      <button className="w-full bg-purple-500 hover:bg-purple-600 text-white rounded-xl py-2 font-semibold">è§£é–</button>
    </form>
  );
}

function DiaryApp({ monthDate, setMonthDate, selectedDate, setSelectedDate, cryptoKey, logout, resetAll }) {
  const year = monthDate.getFullYear();
  const month = monthDate.getMonth();
  const cells = useMemo(() => getMonthMatrix(year, month), [year, month]);

  const [refreshKey, setRefreshKey] = useState(0);

  // ç•¶æœˆå“ªäº›æ—¥æœŸæœ‰è³‡æ–™
  const entryMap = useMemo(() => {
    const map = new Set();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    for (let d = 1; d <= daysInMonth; d++) {
      const k = `${LS_PREFIX}${year}-${String(month + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
      if (localStorage.getItem(k)) map.add(d);
    }
    return map;
  }, [year, month, selectedDate, refreshKey]);

  const today = new Date();
  const todayStr = toDateStr(today);

  // è®€å¯«æ¯æ—¥æ¢ç›®
  const readEntry = async (dateStr) => {
    const raw = localStorage.getItem(`${LS_PREFIX}${dateStr}`);
    if (!raw) return null;
    const payload = JSON.parse(raw);
    const obj = await decryptJSON(payload, cryptoKey);
    if (!Array.isArray(obj.tasks)) obj.tasks = [];
    if (!Array.isArray(obj.images)) obj.images = [];
    if (!Array.isArray(obj.stickers)) obj.stickers = [];
    return obj;
  };
  const writeEntry = async (dateStr, obj) => {
    const payload = await encryptJSON(obj, cryptoKey);
    localStorage.setItem(`${LS_PREFIX}${dateStr}`, JSON.stringify(payload));
    setRefreshKey((v) => v + 1);
  };

  // è®€å¯«æ¨¡æ¿ï¼ˆåŠ å¯†ï¼‰
  const readTemplates = async () => {
    const raw = localStorage.getItem(LS_TEMPLATES);
    if (!raw) return [];
    const payload = JSON.parse(raw);
    try { return await decryptJSON(payload, cryptoKey); } catch { return []; }
  };
  const writeTemplates = async (arr) => {
    const payload = await encryptJSON(arr, cryptoKey);
    localStorage.setItem(LS_TEMPLATES, JSON.stringify(payload));
  };

  // è®€å¯«è‡ªè¨‚è²¼åœ–åº«ï¼ˆåŠ å¯†ï¼‰
  const readCustomStickers = async () => {
    const raw = localStorage.getItem(LS_CSTICKERS);
    if (!raw) return [];
    const payload = JSON.parse(raw);
    try { return await decryptJSON(payload, cryptoKey); } catch { return []; }
  };
  const writeCustomStickers = async (arr) => {
    const payload = await encryptJSON(arr, cryptoKey);
    localStorage.setItem(LS_CSTICKERS, JSON.stringify(payload));
  };

  // iOS / å…§å»ºç€è¦½å™¨æç¤ºèˆ‡åŒ¯å…¥ ref
  const importRef = useRef(null);
  const inApp = /FBAN|FBAV|Instagram|Line\//i.test(navigator.userAgent || "");
  const isStandalone = (window?.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || window?.navigator?.standalone;

  // ä»Šå¤©çš„å¾…è¾¦
  const [todayTasks, setTodayTasks] = useState([]);
  const [newTaskText, setNewTaskText] = useState("");

  const refreshToday = async () => {
    const obj = await readEntry(todayStr);
    setTodayTasks(obj?.tasks || []);
  };
  useEffect(() => { refreshToday(); /* eslint-disable-next-line */ }, [cryptoKey]);

  const mutateToday = async (mutator) => {
    const obj = (await readEntry(todayStr)) || { text: "", images: [], stickers: [], tasks: [], lastModified: Date.now() };
    const newObj = mutator({ ...obj, tasks: Array.isArray(obj.tasks) ? obj.tasks : [] });
    newObj.lastModified = Date.now();
    await writeEntry(todayStr, newObj);
    setTodayTasks(newObj.tasks);
  };

  const addTodayTask = async () => {
    const t = newTaskText.trim();
    if (!t) return;
    await mutateToday((o) => ({ ...o, tasks: [{ id: Date.now() + Math.random(), text: t, done: false }, ...o.tasks] }));
    setNewTaskText("");
  };

  const toggleTodayTask = async (id) => {
    await mutateToday((o) => ({ ...o, tasks: o.tasks.map((it) => (it.id === id ? { ...it, done: !it.done } : it)) }));
  };

  const updateTodayTaskText = async (id, text) => {
    await mutateToday((o) => ({ ...o, tasks: o.tasks.map((it) => (it.id === id ? { ...it, text } : it)) }));
  };

  const removeTodayTask = async (id) => {
    await mutateToday((o) => ({ ...o, tasks: o.tasks.filter((it) => it.id !== id) }));
  };

  const reorderTodayTasks = async (fromId, toId) => {
    await mutateToday((o) => ({ ...o, tasks: reorderByIds(o.tasks, fromId, toId) }));
  };

  // é€¾æœŸ/è·¨æ—¥æé†’ï¼ˆæœ€è¿‘ 7 å¤©æœªå®Œæˆï¼‰
  const [overdue, setOverdue] = useState([]);
  const refreshOverdue = async () => {
    const list = [];
    for (let i = 1; i <= 7; i++) {
      const d = new Date(today);
      d.setDate(today.getDate() - i);
      const ds = toDateStr(d);
      const o = await readEntry(ds);
      if (o?.tasks?.length) {
        for (const t of o.tasks) if (!t.done) list.push({ dateStr: ds, id: t.id, text: t.text });
      }
    }
    setOverdue(list);
  };
  useEffect(() => { refreshOverdue(); /* eslint-disable-next-line */ }, [cryptoKey, refreshKey]);

  const carryOneToToday = async (item, alsoComplete = true) => {
    await mutateToday((o) => ({ ...o, tasks: [{ id: Date.now() + Math.random(), text: item.text, done: false }, ...o.tasks] }));
    if (alsoComplete) {
      const src = await readEntry(item.dateStr);
      if (src) {
        src.tasks = src.tasks.map((x) => (x.id === item.id ? { ...x, done: true } : x));
        src.lastModified = Date.now();
        await writeEntry(item.dateStr, src);
      }
    }
    refreshOverdue();
  };
  const carryAllOverdue = async (alsoComplete = true) => {
    for (const it of overdue) await carryOneToToday(it, alsoComplete);
  };

  // æ¨¡æ¿
  const [templates, setTemplates] = useState([]);
  const [templateOpen, setTemplateOpen] = useState(false);
  const [boardOpen, setBoardOpen] = useState(false);
  const loadTemplates = async () => setTemplates(await readTemplates());
  useEffect(() => { loadTemplates(); /* eslint-disable-next-line */ }, [cryptoKey]);

  const applyTemplatesToToday = async () => {
    if (!templates.length) return alert("ç›®å‰æ²’æœ‰æ¨¡æ¿é …ç›®ï¼Œå¯å…ˆåˆ°ã€ç·¨è¼¯æ¨¡æ¿ã€æ–°å¢ã€‚");
    await mutateToday((o) => ({
      ...o,
      tasks: [
        ...templates.map((t) => ({ id: Date.now() + Math.random(), text: t, done: false })),
        ...o.tasks,
      ],
    }));
  };

  const goPrev = () => setMonthDate(new Date(year, month - 1, 1));
  const goNext = () => setMonthDate(new Date(year, month + 1, 1));
  const openDay = (d) => setSelectedDate(d);
  const openToday = () => setSelectedDate(today);

  return (
    <div className="min-h-screen bg-gradient-to-b from-white to-pink-50 p-4 sm:p-8">
      <div className="mx-auto max-w-5xl">
        {(inApp || isStandalone) && (
          <div className="mb-3 text-xs text-amber-800 bg-amber-50 border border-amber-200 rounded-xl p-2">
            åµæ¸¬åˆ°ä½ å¯èƒ½åœ¨ App å…§å»ºç€è¦½å™¨æˆ–ä¸»ç•«é¢ App æ¨¡å¼ã€‚è‹¥ç„¡æ³•é¸æ“‡æª”æ¡ˆï¼Œè«‹åœ¨ Safari ä¸­é–‹å•Ÿæ­¤ç¶²ç«™å¾Œå†è©¦ï¼ˆåˆ†äº« â†’ åœ¨ Safari æ‰“é–‹ï¼‰ã€‚
          </div>
        )}
        <header className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
          <div>
            <h1 className="text-2xl sm:text-3xl font-bold">å¿ƒæƒ…æ—¥è¨˜</h1>
            <p className="text-xs text-gray-500 mt-1">ğŸ” å·²åŠ å¯† Â· å„²å­˜åœ¨æ­¤ç€è¦½å™¨</p>
          </div>
          <div className="flex flex-wrap items-center gap-2">
            <button onClick={() => exportBackup()} className="px-3 py-2 rounded-xl bg-gray-800 text-white text-sm hover:opacity-90">å‚™ä»½</button>
            <button onClick={() => importRef.current?.click()} className="px-3 py-2 rounded-xl bg-gray-200 text-sm hover:opacity-90">åŒ¯å…¥</button>
            <input ref={importRef} type="file" accept="application/json" className="hidden" onChange={(e) => e.target.files?.[0] && importBackup(e.target.files[0])} />
            <button onClick={applyTemplatesToToday} className="px-3 py-2 rounded-xl bg-emerald-500 text-white text-sm hover:bg-emerald-600">å¥—ç”¨æ¨¡æ¿åˆ°ä»Šå¤©</button>
            <button onClick={() => setTemplateOpen(true)} className="px-3 py-2 rounded-xl bg-emerald-100 text-emerald-800 text-sm hover:bg-emerald-200">ç·¨è¼¯æ¨¡æ¿</button>
            <button onClick={() => setBoardOpen(true)} className="px-3 py-2 rounded-xl bg-blue-100 text-blue-800 text-sm hover:bg-blue-200">å°ˆæ¡ˆé€±çœ‹æ¿</button>
            <button onClick={openToday} className="px-3 py-2 rounded-xl bg-pink-500 text-white text-sm hover:bg-pink-600">ä»Šå¤©æ—¥è¨˜</button>
            <button onClick={logout} className="px-3 py-2 rounded-xl bg-purple-500 text-white text-sm hover:bg-purple-600">ç™»å‡º</button>
            <button onClick={resetAll} className="px-3 py-2 rounded-xl bg-red-500 text-white text-sm hover:bg-red-600">é‡è¨­ï¼ˆæ¸…ç©ºï¼‰</button>
          </div>
        </header>

        {/* ä»Šå¤©çš„å¾…è¾¦ï¼šé€²å…¥å°±çœ‹åˆ° */}
        <TodayTasksCard
          dateStr={todayStr}
          tasks={todayTasks}
          newTaskText={newTaskText}
          setNewTaskText={setNewTaskText}
          addTask={addTodayTask}
          toggleTask={toggleTodayTask}
          updateTaskText={updateTodayTaskText}
          removeTask={removeTodayTask}
          reorderTasks={reorderTodayTasks}
          openToday={openToday}
        />

        {/* é€¾æœŸ/è·¨æ—¥æé†’ */}
        <OverdueCard overdue={overdue} carryOne={carryOneToToday} carryAll={carryAllOverdue} />

        <div className="bg-white/80 backdrop-blur rounded-2xl shadow p-4 sm:p-6 mt-4">
          <div className="flex items-center justify-between mb-4">
            <button onClick={goPrev} className="px-3 py-1.5 rounded-lg bg-gray-100 hover:bg-gray-200">â† ä¸Šå€‹æœˆ</button>
            <div className="font-semibold text-lg">{year} å¹´ {month + 1} æœˆ</div>
            <button onClick={goNext} className="px-3 py-1.5 rounded-lg bg-gray-100 hover:bg-gray-200">ä¸‹å€‹æœˆ â†’</button>
          </div>
          <CalendarGrid cells={cells} entryMap={entryMap} todayStr={todayStr} onPick={openDay} />
        </div>

        {selectedDate && (
          <EntryModal
            date={selectedDate}
            onClose={() => setSelectedDate(null)}
            onChanged={() => {
              if (toDateStr(selectedDate) === todayStr) refreshToday();
              setRefreshKey((v) => v + 1);
              refreshOverdue();
            }}
            cryptoKey={cryptoKey}
            readCustomStickers={readCustomStickers}
            writeCustomStickers={writeCustomStickers}
          />
        )}

        {templateOpen && (
          <TemplateModal
            onClose={() => setTemplateOpen(false)}
            templates={templates}
            setTemplates={setTemplates}
            saveTemplates={async (arr) => { await writeTemplates(arr); setTemplates(arr); }}
          />
        )}

        {boardOpen && (
          <WeeklyBoardModal cryptoKey={cryptoKey} onClose={() => setBoardOpen(false)} />
        )}

            templates={templates}
            setTemplates={setTemplates}
            saveTemplates={async (arr) => { await writeTemplates(arr); setTemplates(arr); }}
          />
        )}

        <footer className="text-center text-xs text-gray-400 mt-6">
          <p>å°æé†’ï¼šå¤§é‡ç…§ç‰‡/è²¼åœ–æœƒä½”ç”¨ç€è¦½å™¨ç©ºé–“ï¼Œå»ºè­°ä¸å®šæœŸå‚™ä»½èˆ‡æ¸…ç†ã€‚</p>
        </footer>
      </div>
    </div>
  );

  // åŒ¯å‡º/åŒ¯å…¥
  function exportBackup() {
    const data = {};
    for (const k of Object.keys(localStorage)) if (k.startsWith(LS_PREFIX)) data[k] = localStorage.getItem(k);
    const blob = new Blob([JSON.stringify({ _meta: { when: new Date().toISOString() }, data }, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `mood-diary-backup-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }

  async function importBackup(file) {
    try {
      const text = await file.text();
      const parsed = JSON.parse(text);
      if (!parsed?.data || typeof parsed.data !== "object") throw new Error("æ ¼å¼éŒ¯èª¤");
      if (!confirm("åŒ¯å…¥å°‡è¦†è“‹ç¾æœ‰ç›¸åŒéµå€¼çš„è³‡æ–™ï¼Œç¹¼çºŒå—ï¼Ÿ")) return;
      for (const [k, v] of Object.entries(parsed.data)) localStorage.setItem(k, v);
      alert("åŒ¯å…¥æˆåŠŸã€‚");
      setRefreshKey((v) => v + 1);
      refreshToday();
      refreshOverdue();
      loadTemplates();
    } catch (e) {
      console.error(e);
      alert("åŒ¯å…¥å¤±æ•—ï¼šæ ¼å¼ä¸æ­£ç¢ºæˆ–æª”æ¡ˆææ¯€ã€‚");
    }
  }
}

function TodayTasksCard({ dateStr, tasks, newTaskText, setNewTaskText, addTask, toggleTask, updateTaskText, removeTask, reorderTasks, openToday }) {
  const hasTasks = tasks && tasks.length > 0;
  const done = tasks.filter((t) => t.done).length;
  const total = tasks.length;
  const pct = total ? Math.round((done * 100) / total) : 0;

  const [dragId, setDragId] = useState(null);

  return (
    <div className={"rounded-2xl shadow "+ (hasTasks?"bg-white/90":"bg-white/70") +" p-4 sm:p-6"}>
      <div className="flex items-center justify-between mb-3">
        <div>
          <div className="text-sm text-gray-500">ä»Šå¤© {dateStr}</div>
          <div className="text-lg font-semibold">ä»Šå¤©çš„å¾…è¾¦</div>
        </div>
        <div className="flex items-center gap-3">
          {/* å®Œæˆç‡åœ“é¤… */}
          <div className="relative w-10 h-10 rounded-full" style={{ background: `conic-gradient(#ec4899 ${pct}%, #e5e7eb 0)` }}>
            <div className="absolute inset-1 rounded-full bg-white flex items-center justify-center text-xs text-gray-600">{done}/{total}</div>
          </div>
          <button onClick={openToday} className="px-3 py-1.5 rounded-lg bg-pink-500 text-white text-sm hover:bg-pink-600">ç·¨è¼¯ä»Šå¤©æ—¥è¨˜</button>
        </div>
      </div>

      {/* å¿«é€Ÿæ–°å¢ */}
      <div className="flex items-center gap-2 mb-3">
        <input
          value={newTaskText}
          onChange={(e) => setNewTaskText(e.target.value)}
          onKeyDown={(e) => { if (e.key === 'Enter') addTask(); }}
          placeholder={hasTasks ? "æ–°å¢å¾…è¾¦..." : "å¯«ä¸‹ä»Šå¤©è¦åšçš„äº‹ï¼ˆEnter æ–°å¢ï¼‰"}
          className="flex-1 border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-300"
        />
        <button onClick={addTask} className="px-3 py-2 rounded-xl bg-gray-800 text-white text-sm">æ–°å¢</button>
      </div>

      {hasTasks ? (
        <ul className="space-y-2">
          {tasks.map((t) => (
            <li
              key={t.id}
              className="flex items-center gap-2 p-2 rounded-lg border bg-white"
              draggable
              onDragStart={() => setDragId(t.id)}
              onDragOver={(e) => e.preventDefault()}
              onDrop={() => { if (dragId && dragId !== t.id) reorderTasks(dragId, t.id); setDragId(null); }}
            >
              <span className="cursor-grab select-none px-1 text-gray-400">â‹®â‹®</span>
              <input type="checkbox" checked={!!t.done} onChange={() => toggleTask(t.id)} className="w-5 h-5" />
              <input
                className={"flex-1 bg-transparent focus:outline-none " + (t.done ? "line-through text-gray-400" : "")}
                value={t.text}
                onChange={(e) => updateTaskText(t.id, e.target.value)}
              />
              <button onClick={() => removeTask(t.id)} className="text-xs text-red-600 hover:underline">åˆªé™¤</button>
            </li>
          ))}
        </ul>
      ) : (
        <div className="text-sm text-gray-500">ä»Šå¤©é‚„æ²’æœ‰å¾…è¾¦ï¼Œå…ˆå¯«ä¸€å€‹å§ï¼</div>
      )}
    </div>
  );
}

function OverdueCard({ overdue, carryOne, carryAll }) {
  if (!overdue?.length) return null;
  return (
    <div className="rounded-2xl shadow bg-white p-4 sm:p-6 mt-4">
      <div className="flex items-center justify-between mb-2">
        <div className="text-lg font-semibold">è·¨æ—¥æé†’ï¼ˆæœ€è¿‘ 7 å¤©æœªå®Œæˆï¼‰</div>
        <div className="flex items-center gap-2 text-sm">
          <button onClick={() => carryAll(true)} className="px-3 py-1.5 rounded-lg bg-emerald-500 text-white hover:bg-emerald-600">å…¨éƒ¨å¸¶åˆ°ä»Šå¤©ä¸¦æ¨™è¨˜åŸä»»å‹™å®Œæˆ</button>
          <button onClick={() => carryAll(false)} className="px-3 py-1.5 rounded-lg bg-gray-200 hover:bg-gray-300">å…¨éƒ¨å¸¶åˆ°ä»Šå¤©ï¼ˆä¸æ¨™è¨˜å®Œæˆï¼‰</button>
        </div>
      </div>
      <ul className="space-y-2">
        {overdue.map((it, i) => (
          <li key={i} className="flex items-center justify-between p-2 rounded-lg border bg-white">
            <div className="text-sm"><span className="text-gray-500 mr-2">{it.dateStr}</span>{it.text}</div>
            <div className="flex items-center gap-2 text-xs">
              <button onClick={() => carryOne(it, true)} className="px-2 py-1 rounded bg-emerald-100 text-emerald-800 hover:bg-emerald-200">å¸¶åˆ°ä»Šå¤©+å®ŒæˆåŸä»»å‹™</button>
              <button onClick={() => carryOne(it, false)} className="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200">åªå¸¶åˆ°ä»Šå¤©</button>
            </div>
          </li>
        ))}
      </ul>
    </div>
  );
}

function CalendarGrid({ cells, entryMap, todayStr, onPick }) {
  const weekdays = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
  return (
    <div>
      <div className="grid grid-cols-7 text-center text-sm text-gray-500 mb-2">
        {weekdays.map((w) => (
          <div key={w} className="py-1">{w}</div>
        ))}
      </div>
      <div className="grid grid-cols-7 gap-1 sm:gap-2">
        {cells.map((d, idx) => {
          if (!d) return <div key={idx} className="aspect-square rounded-xl bg-transparent" />;
          const dateStr = toDateStr(d);
          const isToday = dateStr === todayStr;
          const has = entryMap.has(d.getDate());
          return (
            <button
              key={idx}
              onClick={() => onPick(d)}
              className={
                "aspect-square rounded-xl p-2 text-left border hover:shadow transition " +
                (isToday ? "border-pink-400 bg-pink-50" : "border-gray-200 bg-white")
              }
              title={has ? "æœ‰æ—¥è¨˜/å¾…è¾¦" : ""}
            >
              <div className="flex items-center justify-between">
                <div className="text-sm font-semibold">{d.getDate()}</div>
                {has && <span className="inline-block w-2 h-2 rounded-full bg-pink-500" />}
              </div>
            </button>
          );
        })}
      </div>
    </div>
  );
}

function EntryModal({ date, onClose, onChanged, cryptoKey, readCustomStickers, writeCustomStickers }) {
  const dateStr = toDateStr(date);
  const [text, setText] = useState("");
  const [images, setImages] = useState([]); // DataURL é™£åˆ—
  const [stickers, setStickers] = useState([]); // å¯æ··åˆï¼šemoji å­—å…ƒ æˆ– data:image/* DataURL
  const [tasks, setTasks] = useState([]);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [newTask, setNewTask] = useState("");

  // è‡ªè¨‚è²¼åœ–åº«
  const [libStickers, setLibStickers] = useState([]);

  useEffect(() => {
    (async () => {
      try {
        const raw = localStorage.getItem(`${LS_PREFIX}${dateStr}`);
        if (raw) {
          const payload = JSON.parse(raw);
          const obj = await decryptJSON(payload, cryptoKey);
          setText(obj.text || "");
          setImages(Array.isArray(obj.images) ? obj.images : []);
          const st = Array.isArray(obj.stickers) ? obj.stickers : [];
          setStickers(st);
          setTasks(Array.isArray(obj.tasks) ? obj.tasks : []);
        }
        if (readCustomStickers) setLibStickers(await readCustomStickers());
      } catch (e) {
        console.error(e);
        alert("è®€å–è³‡æ–™å¤±æ•—ï¼Œå¯èƒ½æ˜¯å¯†ç¢¼è®Šæ›´æˆ–è³‡æ–™ææ¯€ã€‚");
      } finally {
        setLoading(false);
      }
    })();
  }, [dateStr, cryptoKey]);

  const onAddImages = async (files) => {
    const list = Array.from(files || []);
    const converted = [];
    for (const f of list) converted.push(await fileToDataURLCompressed(f));
    setImages((prev) => [...converted, ...prev]);
  };

  const onSave = async () => {
    try {
      setSaving(true);
      const payload = await encryptJSON({ text, images, stickers, tasks, lastModified: Date.now() }, cryptoKey);
      localStorage.setItem(`${LS_PREFIX}${dateStr}`, JSON.stringify(payload));
      onClose();
      onChanged && onChanged();
    } catch (e) {
      console.error(e);
      alert("å„²å­˜å¤±æ•—");
    } finally {
      setSaving(false);
    }
  };

  const onDelete = () => {
    if (!confirm("åˆªé™¤æ­¤æ—¥æœŸçš„æ—¥è¨˜èˆ‡åœ–ç‰‡/å¾…è¾¦ï¼Ÿ")) return;
    localStorage.removeItem(`${LS_PREFIX}${dateStr}`);
    onClose();
    onChanged && onChanged();
  };

  const addStickerEmoji = (s) => setStickers((prev) => [s, ...prev]);
  const removeImage = (idx) => setImages((prev) => prev.filter((_, i) => i !== idx));
  const removeSticker = (idx) => setStickers((prev) => prev.filter((_, i) => i !== idx));

  // å¾…è¾¦ï¼ˆåœ¨æ—¥è¨˜è¦–çª—å…§ï¼‰å«æ‹–æ‹‰æ’åº
  const [dragId, setDragId] = useState(null);
  const addTask = () => {
    const t = newTask.trim();
    if (!t) return;
    setTasks((prev) => [{ id: Date.now() + Math.random(), text: t, done: false }, ...prev]);
    setNewTask("");
  };
  const toggleTask = (id) => setTasks((prev) => prev.map((x) => (x.id === id ? { ...x, done: !x.done } : x)));
  const updateTaskText = (id, text) => setTasks((prev) => prev.map((x) => (x.id === id ? { ...x, text } : x)));
  const removeTask = (id) => setTasks((prev) => prev.filter((x) => x.id !== id));
  const reorderTaskLocal = (from, to) => setTasks((prev) => reorderByIds(prev, from, to));

  // è‡ªè¨‚è²¼åœ–åº«ï¼šä¸Šå‚³/åˆªé™¤/é»é¸æ’å…¥
  const onUploadStickers = async (files) => {
    const list = Array.from(files || []);
    const converted = [];
    for (const f of list) converted.push(await fileToDataURLCompressed(f));
    const newLib = [...converted, ...libStickers];
    setLibStickers(newLib);
    if (writeCustomStickers) await writeCustomStickers(newLib);
  };
  const deleteLibSticker = async (idx) => {
    const newLib = libStickers.filter((_, i) => i !== idx);
    setLibStickers(newLib);
    if (writeCustomStickers) await writeCustomStickers(newLib);
  };
  const useLibSticker = (src) => setStickers((prev) => [src, ...prev]);

  const renderStickerItem = (s, i) => {
    const isImg = typeof s === 'string' && s.startsWith('data:image');
    return (
      <div key={i} className="relative">
        {isImg ? (
          <img src={s} alt="sticker" className="w-12 h-12 object-contain" />
        ) : (
          <span className="text-3xl leading-none">{s}</span>
        )}
        <button onClick={() => removeSticker(i)} className="absolute -top-2 -right-2 bg-black/60 text-white text-xs rounded-full px-1">âœ•</button>
      </div>
    );
  };

  return (
    <div className="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-end sm:items-center justify-center z-50">
      {/* ä½¿æ•´å€‹å½ˆçª—æˆç‚º flex å®¹å™¨ï¼Œå…§å®¹å€å¯ç¨ç«‹æ»¾å‹•ï¼Œåº•éƒ¨æ“ä½œåˆ—æ°¸é å¯è¦‹ */}
      <div className="w-full sm:max-w-3xl bg-white rounded-t-2xl sm:rounded-2xl shadow-xl max-h-[90svh] sm:max-h-[90vh] overflow-hidden flex flex-col">
        <div className="flex items-center justify-between px-4 sm:px-6 py-3 border-b shrink-0">
          <div className="font-semibold">{dateStr} çš„å¿ƒæƒ…</div>
          <button onClick={onClose} className="text-gray-500 hover:text-gray-700">âœ•</button>
        </div>

        {/* å…§å®¹å€å¯æ»¾å‹• */}
        <div className="flex-1 overflow-y-auto p-4 sm:p-6 space-y-6">
          {loading ? (
            <div className="text-center text-gray-500">è¼‰å…¥ä¸­â€¦</div>
          ) : (
            <>
              <section>
                <label className="text-sm text-gray-600">æ–‡å­—å…§å®¹</label>
                <textarea
                  value={text}
                  onChange={(e) => setText(e.target.value)}
                  rows={6}
                  className="mt-1 w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-300"
                  placeholder="ä»Šå¤©çš„å¿ƒæƒ…â‹¯â‹¯"
                />
              </section>

              <section className="space-y-2">
                <div className="flex items-center justify-between">
                  <div className="text-sm text-gray-600">ç…§ç‰‡</div>
                  <label className="px-3 py-1.5 rounded-lg bg-gray-100 text-sm cursor-pointer hover:bg-gray-200">
                    æ–°å¢ç…§ç‰‡
                    <input type="file" accept="image/*" multiple className="hidden" onChange={(e) => onAddImages(e.target.files)} />
                  </label>
                </div>
                {images.length === 0 ? (
                  <div className="text-xs text-gray-400">å°šæœªåŠ å…¥ç…§ç‰‡</div>
                ) : (
                  <div className="grid grid-cols-3 sm:grid-cols-4 gap-2">
                    {images.map((src, idx) => (
                      <div key={idx} className="relative group">
                        <img src={src} alt="uploaded" className="w-full h-24 object-cover rounded-lg border" />
                        <button onClick={() => removeImage(idx)} className="absolute top-1 right-1 bg-black/60 text-white text-xs px-1.5 py-0.5 rounded opacity-0 group-hover:opacity-100">åˆªé™¤</button>
                      </div>
                    ))}
                  </div>
                )}
              </section>

              {/* å¯æ„›è²¼åœ–ï¼ˆå…§å»º + è‡ªè¨‚è²¼åœ–åº«ï¼‰ */}
              <section className="space-y-3">
                <div className="text-sm text-gray-600">å¯æ„›è²¼åœ–</div>
                <div className="flex flex-wrap gap-2">
                  {STICKERS.map((s) => (
                    <button key={s} onClick={() => addStickerEmoji(s)} className="text-2xl hover:scale-110 transition">{s}</button>
                  ))}
                </div>

                <div className="mt-2">
                  <div className="flex items-center justify-between mb-2">
                    <div className="text-sm text-gray-600">è‡ªè¨‚è²¼åœ–åº«ï¼ˆé»æ“Šå¯æ’å…¥ï¼‰</div>
                    <label className="px-3 py-1.5 rounded-lg bg-gray-100 text-sm cursor-pointer hover:bg-gray-200">
                      ä¸Šå‚³è²¼åœ–
                      <input type="file" accept="image/*" multiple className="hidden" onChange={async (e) => e.target.files?.length && (await onUploadStickers(e.target.files))} />
                    </label>
                  </div>
                  {libStickers.length ? (
                    <div className="grid grid-cols-6 sm:grid-cols-8 gap-2">
                      {libStickers.map((src, idx) => (
                        <div key={idx} className="relative group">
                          <img src={src} alt="sticker" className="w-12 h-12 object-contain border rounded-lg bg-white cursor-pointer" onClick={() => useLibSticker(src)} />
                          <button onClick={() => deleteLibSticker(idx)} className="absolute -top-2 -right-2 bg-black/60 text-white text-[10px] rounded-full px-1 opacity-0 group-hover:opacity-100">âœ•</button>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className="text-xs text-gray-400">å°šç„¡è‡ªè¨‚è²¼åœ–ï¼Œå…ˆä¸Šå‚³ PNG/JPG è©¦è©¦ï¼</div>
                  )}
                </div>

                {stickers.length > 0 && (
                  <div className="flex flex-wrap gap-2 mt-2">
                    {stickers.map((s, i) => renderStickerItem(s, i))}
                  </div>
                )}
              </section>

              {/* å¾…è¾¦æ¸…å–®ï¼ˆå«æ‹–æ‹‰æ’åºï¼‰ */}
              <section className="space-y-2">
                <div className="text-sm text-gray-600">ç•¶æ—¥äº‹é …ï¼ˆå¯æ‰“å‹¾ï¼Œæ‹–æ‹‰æ’åºï¼‰</div>
                <div className="flex items-center gap-2">
                  <input
                    value={newTask}
                    onChange={(e) => setNewTask(e.target.value)}
                    onKeyDown={(e) => { if (e.key === 'Enter') addTask(); }}
                    placeholder="è¼¸å…¥å¾…è¾¦ï¼ŒEnter æ–°å¢"
                    className="flex-1 border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-300"
                  />
                  <button onClick={addTask} className="px-3 py-2 rounded-xl bg-gray-800 text-white text-sm">æ–°å¢</button>
                </div>
                {tasks.length > 0 ? (
                  <ul className="space-y-2">
                    {tasks.map((t) => (
                      <li
                        key={t.id}
                        className="flex items-center gap-2 p-2 rounded-lg border bg-white"
                        draggable
                        onDragStart={() => setDragId(t.id)}
                        onDragOver={(e) => e.preventDefault()}
                        onDrop={() => { if (dragId && dragId !== t.id) reorderTaskLocal(dragId, t.id); setDragId(null); }}
                      >
                        <span className="cursor-grab select-none px-1 text-gray-400">â‹®â‹®</span>
                        <input type="checkbox" checked={!!t.done} onChange={() => toggleTask(t.id)} className="w-5 h-5" />
                        <input
                          className={"flex-1 bg-transparent focus:outline-none " + (t.done ? "line-through text-gray-400" : "")}
                          value={t.text}
                          onChange={(e) => updateTaskText(t.id, e.target.value)}
                        />
                        <button onClick={() => removeTask(t.id)} className="text-xs text-red-600 hover:underline">åˆªé™¤</button>
                      </li>
                    ))}
                  </ul>
                ) : (
                  <div className="text-xs text-gray-400">é‚„æ²’æœ‰äº‹é …ï¼Œå…ˆåŠ ä¸€å€‹å§ï¼</div>
                )}
              </section>
            </>
          )}
        </div>

        {/* åº•éƒ¨æ“ä½œåˆ—ä¿æŒå¯è¦‹ */}
        <div className="flex items-center justify-between px-4 sm:px-6 py-3 border-t bg-white/95 backdrop-blur sticky bottom-0 shrink-0">
          <button onClick={onDelete} className="px-3 py-2 rounded-xl bg-red-100 text-red-700 hover:bg-red-200">åˆªé™¤æ­¤æ—¥</button>
          <div className="flex items-center gap-2">
            <button onClick={onClose} className="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200">å–æ¶ˆ</button>
            <button onClick={onSave} disabled={saving} className="px-4 py-2 rounded-xl bg-pink-500 text-white hover:bg-pink-600 disabled:opacity-60">
              {saving ? "å„²å­˜ä¸­â€¦" : "å„²å­˜"}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function TemplateModal({ onClose, templates, setTemplates, saveTemplates }) {
  const [newItem, setNewItem] = useState("");
  const [dragIdx, setDragIdx] = useState(null);

  const add = () => {
    const t = newItem.trim();
    if (!t) return;
    setTemplates([...templates, t]);
    setNewItem("");
  };
  const del = (i) => setTemplates(templates.filter((_, idx) => idx !== i));
  const update = (i, v) => setTemplates(templates.map((x, idx) => (idx === i ? v : x)));
  const reorder = (from, to) => {
    if (from === to || from == null || to == null) return;
    const arr = [...templates];
    const [item] = arr.splice(from, 1);
    arr.splice(to, 0, item);
    setTemplates(arr);
  };

  return (
    <div className="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50">
      <div className="w-full sm:max-w-lg bg-white rounded-2xl shadow-xl max-h-[90svh] sm:max-h-[90vh] overflow-hidden flex flex-col">
        <div className="flex items-center justify-between px-4 sm:px-6 py-3 border-b shrink-0">
          <div className="font-semibold">ç·¨è¼¯æ¯æ—¥æ¨¡æ¿</div>
          <button onClick={onClose} className="text-gray-500 hover:text-gray-700">âœ•</button>
        </div>
        <div className="flex-1 overflow-y-auto p-4 sm:p-6 space-y-4">
          <div className="flex items-center gap-2">
            <input
              value={newItem}
              onChange={(e) => setNewItem(e.target.value)}
              onKeyDown={(e) => { if (e.key === 'Enter') add(); }}
              placeholder="è¼¸å…¥æ¨¡æ¿é …ç›®ï¼ŒEnter æ–°å¢"
              className="flex-1 border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-300"
            />
            <button onClick={add} className="px-3 py-2 rounded-xl bg-emerald-500 text-white text-sm">æ–°å¢</button>
          </div>

          {templates?.length ? (
            <ul className="space-y-2">
              {templates.map((t, i) => (
                <li
                  key={i}
                  className="flex items-center gap-2 p-2 rounded-lg border bg-white"
                  draggable
                  onDragStart={() => setDragIdx(i)}
                  onDragOver={(e) => e.preventDefault()}
                  onDrop={() => { if (dragIdx != null && dragIdx !== i) reorder(dragIdx, i); setDragIdx(null); }}
                >
                  <span className="cursor-grab select-none px-1 text-gray-400">â‹®â‹®</span>
                  <input className="flex-1 bg-transparent focus:outline-none" value={t} onChange={(e) => update(i, e.target.value)} />
                  <button onClick={() => del(i)} className="text-xs text-red-600 hover:underline">åˆªé™¤</button>
                </li>
              ))}
            </ul>
          ) : (
            <div className="text-xs text-gray-400">é‚„æ²’æœ‰æ¨¡æ¿ï¼Œå…ˆæ–°å¢å¹¾å€‹å¸¸ç”¨é …ç›®å§ï¼ˆä¾‹å¦‚ï¼šå– 2000ml æ°´ã€30 åˆ†é˜é‹å‹•ã€é–±è®€ 20 åˆ†é˜â‹¯â‹¯ï¼‰ã€‚</div>
          )}
        </div>
        <div className="flex items-center justify-end gap-2 px-4 sm:px-6 py-3 border-t bg-white/95 backdrop-blur sticky bottom-0 shrink-0">
          <button onClick={onClose} className="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200">å–æ¶ˆ</button>
          <button onClick={async () => { await saveTemplates(templates); onClose(); }} className="px-4 py-2 rounded-xl bg-emerald-500 text-white hover:bg-emerald-600">å„²å­˜æ¨¡æ¿</button>
        </div>
      </div>
    </div>
  );
}

// ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼
// å°ˆæ¡ˆã€Œé€±çœ‹æ¿ã€ï¼šè¿½è¹¤ä¸€ä»¶äº‹åœ¨æœ¬é€±æ¯å¤©çš„é€²åº¦
// å·¦æ¬„ï¼šæœ¬é€±è¦åšä»€éº¼ï¼›å³å´ï¼šé€±ä¸€ï½é€±æ—¥æ¯å¤©å¯å¡«é è¨ˆé€²åº¦ï¼Œä¸¦æ¨™è¨˜ç‹€æ…‹ï¼ˆç¶ =å¦‚æœŸå®Œæˆã€é»ƒ=å»¶å®•ã€è—=è¨ˆç•«ä¸­ï¼‰
// ä»¥é€±ä¸€æ—¥æœŸç‚º keyï¼Œå…§å®¹åŠ å¯†å¾Œå­˜åˆ° localStorage
function WeeklyBoardModal({ cryptoKey, onClose }) {
  const getMonday = (d) => {
    const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const day = x.getDay(); // 0=æ—¥
    const diff = (day === 0 ? -6 : 1 - day); // å–å¾—é€±ä¸€
    x.setDate(x.getDate() + diff);
    x.setHours(0,0,0,0);
    return x;
  };
  const [weekStart, setWeekStart] = useState(getMonday(new Date()));
  const days = useMemo(() => Array.from({ length: 7 }, (_, i) => { const d = new Date(weekStart); d.setDate(d.getDate() + i); return d; }), [weekStart]);

  const weekKey = (d) => `${LS_PREFIX}board_${toDateStr(d)}`;

  const [rows, setRows] = useState([]); // æ¯åˆ—ï¼š{ id, title, daily: { [YYYY-MM-DD]: { plan:"", status:"plan|done|delay|none" } } }
  const [loading, setLoading] = useState(true);

  const load = async () => {
    setLoading(true);
    const raw = localStorage.getItem(weekKey(weekStart));
    if (!raw) { setRows([]); setLoading(false); return; }
    try {
      const obj = await decryptJSON(JSON.parse(raw), cryptoKey);
      setRows(Array.isArray(obj.rows) ? obj.rows : []);
    } catch { setRows([]); }
    setLoading(false);
  };
  useEffect(() => { load(); /* eslint-disable-next-line */ }, [cryptoKey, weekStart]);

  const save = async (nextRows) => {
    const payload = await encryptJSON({ rows: nextRows, savedAt: Date.now() }, cryptoKey);
    localStorage.setItem(weekKey(weekStart), JSON.stringify(payload));
  };

  const addRow = () => {
    const r = { id: Date.now() + Math.random(), title: "", daily: {} };
    const next = [r, ...rows];
    setRows(next); save(next);
  };
  const delRow = (id) => { const next = rows.filter(r => r.id !== id); setRows(next); save(next); };
  const updateTitle = (id, v) => { const next = rows.map(r => r.id === id ? { ...r, title: v } : r); setRows(next); save(next); };

  const updateCell = (id, ds, patch) => {
    const next = rows.map(r => {
      if (r.id !== id) return r;
      const cur = r.daily?.[ds] || { plan: "", status: "plan" };
      return { ...r, daily: { ...r.daily, [ds]: { ...cur, ...patch } } };
    });
    setRows(next); save(next);
  };

  const cycleStatus = (s) => (s === 'plan' ? 'done' : s === 'done' ? 'delay' : s === 'delay' ? 'none' : 'plan');
  const statusClass = (s) => (
    s === 'done' ? 'bg-emerald-100 border-emerald-300' :
    s === 'delay' ? 'bg-amber-100 border-amber-300' :
    s === 'plan' ? 'bg-sky-50 border-sky-200' : 'bg-white'
  );

  const prevWeek = () => { const d = new Date(weekStart); d.setDate(d.getDate() - 7); setWeekStart(d); };
  const nextWeek = () => { const d = new Date(weekStart); d.setDate(d.getDate() + 7); setWeekStart(d); };

  return (
    <div className="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-end sm:items-center justify-center z-50">
      <div className="w-full sm:max-w-5xl bg-white rounded-t-2xl sm:rounded-2xl shadow-xl max-h-[92svh] sm:max-h-[92vh] overflow-hidden flex flex-col">
        <div className="flex items-center justify-between px-4 sm:px-6 py-3 border-b shrink-0">
          <div className="flex items-center gap-3">
            <button onClick={prevWeek} className="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200">â†</button>
            <div className="font-semibold">å°ˆæ¡ˆé€±çœ‹æ¿ï¼š{toDateStr(days[0])} ~ {toDateStr(days[6])}</div>
            <button onClick={nextWeek} className="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200">â†’</button>
          </div>
          <button onClick={onClose} className="text-gray-500 hover:text-gray-700">âœ•</button>
        </div>

        <div className="p-3 text-xs text-gray-600 flex flex-wrap gap-3 border-b">
          <span className="inline-flex items-center gap-1"><span className="inline-block w-3 h-3 rounded border border-sky-200 bg-sky-50"></span> è¨ˆç•«</span>
          <span className="inline-flex items-center gap-1"><span className="inline-block w-3 h-3 rounded border border-emerald-300 bg-emerald-100"></span> å¦‚æœŸå®Œæˆ</span>
          <span className="inline-flex items-center gap-1"><span className="inline-block w-3 h-3 rounded border border-amber-300 bg-amber-100"></span> å»¶å®•</span>
          <span className="text-gray-400">é»ä¸€ä¸‹æ ¼å­å¯å¾ªç’°åˆ‡æ›ç‹€æ…‹</span>
        </div>

        <div className="flex-1 overflow-auto p-3">
          {loading ? (
            <div className="text-center text-gray-500 py-6">è¼‰å…¥ä¸­â€¦</div>
          ) : (
            <div className="min-w-[800px]">
              <div className="grid grid-cols-[240px_repeat(7,1fr)] text-sm">
                {/* è¡¨é ­ */}
                <div className="p-2 bg-gray-50 border">æœ¬é€±è¦åšä»€éº¼</div>
                {days.map((d) => (
                  <div key={toDateStr(d)} className="p-2 bg-gray-50 border text-center">{toDateStr(d)}</div>
                ))}

                {/* è³‡æ–™åˆ— */}
                {rows.map((r) => (
                  <React.Fragment key={r.id}>
                    <div className="border p-2 flex items-center gap-2">
                      <span className="cursor-grab select-none text-gray-300">â‹®â‹®</span>
                      <input
                        className="flex-1 bg-transparent focus:outline-none"
                        placeholder="ä¾‹å¦‚ï¼šé€±å ±ã€å®¢æˆ¶ç°¡å ±ã€ç ”ç©¶å ±å‘Šâ€¦"
                        value={r.title}
                        onChange={(e) => updateTitle(r.id, e.target.value)}
                      />
                      <button onClick={() => delRow(r.id)} className="text-xs text-red-600 hover:underline">åˆªé™¤</button>
                    </div>
                    {days.map((d) => {
                      const ds = toDateStr(d);
                      const cell = r.daily?.[ds] || { plan: "", status: "plan" };
                      return (
                        <div key={ds} className={`border p-2 ${statusClass(cell.status)} transition`} onClick={() => updateCell(r.id, ds, { status: cycleStatus(cell.status) })}>
                          <textarea
                            className="w-full h-16 resize-none bg-transparent focus:outline-none text-sm"
                            placeholder="é è¨ˆé€²åº¦/äº¤ä»˜â€¦ï¼ˆé»æ ¼å­åˆ‡æ›ç‹€æ…‹ï¼‰"
                            value={cell.plan}
                            onChange={(e) => updateCell(r.id, ds, { plan: e.target.value })}
                            onClick={(e) => e.stopPropagation()}
                          />
                        </div>
                      );
                    })}
                  </React.Fragment>
                ))}
              </div>

              {/* æ–°å¢åˆ— */}
              <div className="mt-3">
                <button onClick={addRow} className="px-3 py-2 rounded-xl bg-gray-800 text-white text-sm">æ–°å¢ä¸€åˆ—</button>
              </div>
            </div>
          )}
        </div>

        <div className="flex items-center justify-end gap-2 px-4 sm:px-6 py-3 border-t bg-white/95 backdrop-blur shrink-0">
          <button onClick={onClose} className="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200">é—œé–‰</button>
        </div>
      </div>
    </div>
  );
}
